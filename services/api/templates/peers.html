<!DOCTYPE html>
<html>
<head>
    <title>ü™∏ Anemone - {{ t['peers_management'] }}</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .nav {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .nav a {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s;
            font-weight: 500;
        }
        .nav a:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px); }
        .nav a.active { background: rgba(255,255,255,0.4); font-weight: 600; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .card h2 { margin-bottom: 20px; color: #333; }

        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }

        .peer-list { list-style: none; }
        .peer-item {
            padding: 16px;
            margin-bottom: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .peer-info { flex: 1; }
        .peer-name { font-weight: 600; color: #333; }
        .peer-ip { color: #666; font-size: 0.9em; }
        .peer-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            margin-left: 10px;
        }
        .status-connected { background: #d4edda; color: #155724; }
        .status-disconnected { background: #f8d7da; color: #721c24; }

        .input-group { margin-bottom: 16px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #555; }
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
        }
        .input-group input:focus { outline: none; border-color: #667eea; }

        .pin-display {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
            text-align: center;
        }
        .pin-number {
            font-size: 2em;
            font-weight: bold;
            color: #856404;
            font-family: monospace;
            letter-spacing: 4px;
        }
        .warning {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
            font-size: 0.9em;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
        }
        .hidden { display: none; }
        .actions { display: flex; gap: 10px; }
        .actions button { flex: 1; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü™∏ Anemone</h1>
            <p>{{ t['peers_management'] }}</p>
        </div>

        <div class="nav">
            <a href="/">üè† {{ t['home'] }}</a>
            <a href="/peers" class="active">üë• {{ t['peers'] }}</a>
            <a href="/api/status">üìä {{ t['api_status'] }}</a>
        </div>

        <!-- Statut VPN -->
        <div class="card" style="margin-bottom:20px">
            <h2>üîí {{ t['wireguard_vpn_status'] }}</h2>
            <div id="vpn-status-card" class="loading">{{ t['loading'] }}</div>
        </div>

        <div class="grid">
            <!-- Section: Mon invitation -->
            <div class="card">
                <h2>üîë {{ t['my_invitation_code'] }}</h2>
                <p style="color:#666; margin-bottom:20px">{{ t['share_code_desc'] }}</p>

                <div class="input-group">
                    <label>
                        <input type="checkbox" id="use-pin"> {{ t['protect_with_pin'] }}
                    </label>
                </div>

                <div id="pin-options" class="hidden">
                    <div class="input-group">
                        <label>{{ t['pin_4_8_digits'] }}</label>
                        <input type="text" id="custom-pin" placeholder="{{ t['leave_empty_auto'] }}" maxlength="8">
                    </div>
                </div>

                <button class="btn" onclick="generateInvitation()">{{ t['generate_code'] }}</button>

                <div id="invitation-result" class="hidden">
                    <div class="input-group">
                        <label>{{ t['json_code_to_share'] }}</label>
                        <textarea id="invitation-json" readonly rows="6" style="width:100%; padding:12px; border:2px solid #667eea; border-radius:8px; font-family:monospace; font-size:12px"></textarea>
                    </div>
                    <div id="pin-info" class="hidden pin-display">
                        <p style="margin-bottom:8px">üì± {{ t['pin_to_communicate'] }}</p>
                        <div class="pin-number" id="pin-value"></div>
                        <p style="margin-top:8px; color:#856404; font-size:0.9em">
                            ‚ö†Ô∏è {{ t['communicate_pin_secure'] }}
                        </p>
                    </div>
                    <button class="btn" onclick="copyInvitation()" style="margin-top:16px">üìã {{ t['copy_code'] }}</button>
                    <div style="background:#e7f3ff; border-left:4px solid #2196f3; padding:12px; margin-top:16px; border-radius:4px">
                        <p style="margin:0; color:#1976d2; font-size:0.9em">
                            üí° <strong>{{ t['tip_send_json'] }}</strong> {{ t['tip_send_json_desc'] }}
                        </p>
                    </div>
                </div>
            </div>

            <!-- Section: Ajouter un pair -->
            <div class="card">
                <h2>‚ûï {{ t['add_peer'] }}</h2>
                <p style="color:#666; margin-bottom:20px">{{ t['paste_json_code'] }}</p>

                <div class="input-group">
                    <label>{{ t['json_code'] }}</label>
                    <textarea id="manual-code" rows="6" style="width:100%; padding:12px; border:2px solid #dee2e6; border-radius:8px; font-family:monospace; font-size:12px"></textarea>
                </div>
                <div class="input-group">
                    <label>{{ t['pin_if_protected'] }}</label>
                    <input type="text" id="manual-pin" placeholder="{{ t['enter_pin'] }}">
                </div>
                <button class="btn" onclick="addPeerManually()">{{ t['add_peer_button'] }}</button>

                <div id="add-result"></div>
            </div>

            <!-- Section: Pairs connect√©s -->
            <div class="card" style="grid-column: 1 / -1;">
                <h2>üë• {{ t['connected_peers_list'] }}</h2>
                <ul class="peer-list" id="peer-list">
                    <li style="text-align:center; color:#999; padding:20px">{{ t['loading'] }}</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Traductions inject√©es c√¥t√© serveur
        const t = {
            pin_must_be_4_8: "{{ t['pin_must_be_4_8'] }}",
            error: "{{ t['error'] }}",
            code_copied: "{{ t['code_copied'] }}",
            copy_manual: "{{ t['copy_manual'] }}",
            enter_json_code: "{{ t['enter_json_code'] }}",
            invalid_code: "{{ t['invalid_code'] }}",
            peer_added_success: "{{ t['peer_added_success'] }}",
            confirm_remove_peer: "{{ t['confirm_remove_peer'] }}",
            remove_error: "{{ t['remove_error'] }}",
            no_peers: "{{ t['no_peers'] }}",
            connected: "{{ t['connected'] }}",
            disconnected: "{{ t['disconnected'] }}",
            remove: "{{ t['remove'] }}",
            status: "{{ t['status'] }}",
            active: "{{ t['active'] }}",
            inactive: "{{ t['inactive'] }}",
            configured_tunnels: "{{ t['configured_tunnels'] }}",
            active_tunnels: "{{ t['active_tunnels'] }}",
            endpoint: "{{ t['endpoint'] }}",
            last_handshake: "{{ t['last_handshake'] }}",
            transfer: "{{ t['transfer'] }}",
            vpn_inactive: "{{ t['vpn_inactive'] }}",
            vpn_status_error: "{{ t['vpn_status_error'] }}"
        };

        let currentInvitation = null;

        // Toggle PIN options
        document.getElementById('use-pin').addEventListener('change', (e) => {
            document.getElementById('pin-options').classList.toggle('hidden', !e.target.checked);
        });

        // G√©n√©rer une invitation
        async function generateInvitation() {
            const usePin = document.getElementById('use-pin').checked;
            const customPin = document.getElementById('custom-pin').value.trim();

            const payload = {};
            if (usePin) {
                if (customPin) {
                    if (!/^\d{4,8}$/.test(customPin)) {
                        alert(t.pin_must_be_4_8);
                        return;
                    }
                    payload.pin = customPin;
                } else {
                    payload.pin_length = 6; // G√©n√©rer un PIN de 6 chiffres
                }
            }

            try {
                const res = await fetch('/api/peers/generate-invitation', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                const data = await res.json();
                currentInvitation = data.invitation;

                // Afficher le JSON dans le textarea
                document.getElementById('invitation-json').value = JSON.stringify(data.invitation, null, 2);

                // Afficher le PIN si prot√©g√©
                if (data.protected && data.pin) {
                    document.getElementById('pin-value').textContent = data.pin;
                    document.getElementById('pin-info').classList.remove('hidden');
                } else {
                    document.getElementById('pin-info').classList.add('hidden');
                }

                document.getElementById('invitation-result').classList.remove('hidden');
            } catch (err) {
                alert(t.error + ': ' + err.message);
            }
        }

        // Copier l'invitation
        function copyInvitation() {
            const textarea = document.getElementById('invitation-json');
            textarea.select();
            textarea.setSelectionRange(0, 99999); // Pour mobile

            try {
                document.execCommand('copy');
                alert('‚úÖ ' + t.code_copied);
            } catch (err) {
                alert(t.copy_manual);
            }
        }

        async function addPeerManually() {
            const code = document.getElementById('manual-code').value.trim();
            const pin = document.getElementById('manual-pin').value.trim();

            if (!code) {
                alert(t.enter_json_code);
                return;
            }

            try {
                const invitation = JSON.parse(code);

                const res = await fetch('/api/peers/add', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        invitation_data: invitation,
                        pin: pin || null
                    })
                });

                const data = await res.json();

                if (data.success) {
                    document.getElementById('add-result').innerHTML = `
                        <div class="success">
                            ‚úÖ ${t.peer_added_success}<br>
                            <strong>${data.peer.name}</strong> (${data.peer.vpn_ip})
                        </div>
                    `;
                    document.getElementById('manual-code').value = '';
                    document.getElementById('manual-pin').value = '';
                    loadPeers();

                    // Effacer apr√®s 5s
                    setTimeout(() => {
                        document.getElementById('add-result').innerHTML = '';
                    }, 5000);
                } else {
                    throw new Error(data.message || t.error);
                }
            } catch (err) {
                document.getElementById('add-result').innerHTML = `
                    <div class="warning">‚ùå ${t.invalid_code}: ${err.message}</div>
                `;
            }
        }

        // Charger la liste des pairs
        async function loadPeers() {
            try {
                const res = await fetch('/api/peers/list');
                const data = await res.json();

                const list = document.getElementById('peer-list');

                if (data.peers.length === 0) {
                    list.innerHTML = `<li style="text-align:center; color:#999; padding:20px">${t.no_peers}</li>`;
                    return;
                }

                list.innerHTML = '';
                for (const peer of data.peers) {
                    const status = await getPeerStatus(peer.name);
                    const statusClass = status.status === 'connected' ? 'status-connected' : 'status-disconnected';
                    const statusText = status.status === 'connected' ? 'üü¢ ' + t.connected : 'üî¥ ' + t.disconnected;

                    const li = document.createElement('li');
                    li.className = 'peer-item';
                    li.innerHTML = `
                        <div class="peer-info">
                            <div class="peer-name">${peer.name}</div>
                            <div class="peer-ip">${peer.vpn_ip} ${peer.endpoint !== 'N/A' ? '‚Ä¢ ' + peer.endpoint : ''}</div>
                        </div>
                        <div>
                            <span class="peer-status ${statusClass}">${statusText}</span>
                            <button class="btn btn-secondary" onclick="removePeer('${peer.name}')" style="margin-left:10px; width:auto; padding:8px 16px">${t.remove}</button>
                        </div>
                    `;
                    list.appendChild(li);
                }
            } catch (err) {
                console.error(err);
                document.getElementById('peer-list').innerHTML = `<li style="color:red">${t.error}</li>`;
            }
        }

        // R√©cup√©rer le statut d'un pair
        async function getPeerStatus(peerName) {
            try {
                const res = await fetch(`/api/peers/${encodeURIComponent(peerName)}/status`);
                return await res.json();
            } catch {
                return { status: 'unknown' };
            }
        }

        // Supprimer un pair
        async function removePeer(peerName) {
            if (!confirm(`${t.confirm_remove_peer} "${peerName}" ?`)) return;

            try {
                const res = await fetch(`/api/peers/${encodeURIComponent(peerName)}`, {
                    method: 'DELETE'
                });

                const data = await res.json();
                if (data.success) {
                    loadPeers();
                } else {
                    alert(t.error + ': ' + (data.message || t.remove_error));
                }
            } catch (err) {
                alert(t.error + ': ' + err.message);
            }
        }

        // Charger le statut VPN
        async function loadVPNStatus() {
            try {
                const res = await fetch('/api/vpn/status');
                const data = await res.json();

                const vpnCard = document.getElementById('vpn-status-card');

                if (data.status === 'up') {
                    let peersHtml = '';
                    if (data.peers && data.peers.length > 0) {
                        peersHtml = `<div style="margin-top:16px"><strong>${t.active_tunnels}</strong></div>`;
                        data.peers.forEach(peer => {
                            peersHtml += `
                                <div style="background:#f8f9fa; padding:12px; margin-top:8px; border-radius:8px">
                                    <div style="font-size:0.9em">
                                        <strong>${t.endpoint}:</strong> ${peer.endpoint || 'N/A'}<br>
                                        <strong>${t.last_handshake}:</strong> ${peer.latest_handshake || t.never || 'Never'}<br>
                                        <strong>${t.transfer}:</strong> ${peer.transfer || t.none || 'None'}
                                    </div>
                                </div>
                            `;
                        });
                    }

                    vpnCard.innerHTML = `
                        <div class="stat">
                            <span class="stat-label">${t.status}</span>
                            <span class="status status-connected">üü¢ ${t.active}</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">${t.configured_tunnels}</span>
                            <span class="stat-value">${data.peers_count || 0}</span>
                        </div>
                        ${peersHtml}
                    `;
                } else {
                    vpnCard.innerHTML = `
                        <div class="stat">
                            <span class="stat-label">${t.status}</span>
                            <span class="status status-disconnected">üî¥ ${t.inactive}</span>
                        </div>
                        <div class="warning" style="margin-top:12px">
                            ${t.vpn_inactive}
                        </div>
                    `;
                }
            } catch (err) {
                document.getElementById('vpn-status-card').innerHTML = `<div class="warning">${t.vpn_status_error}</div>`;
            }
        }

        // Charger les pairs au d√©marrage
        loadPeers();
        loadVPNStatus();

        // Rafra√Æchir le statut VPN toutes les 30 secondes
        setInterval(loadVPNStatus, 30000);
    </script>
</body>
</html>
