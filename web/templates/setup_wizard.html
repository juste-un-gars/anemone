<!DOCTYPE html>
<html lang="{{.Lang}}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{T .Lang "setup_wizard.title"}} - Anemone</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .anemone-gradient { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .step-active { background-color: #6366f1; color: white; }
        .step-completed { background-color: #10b981; color: white; }
        .step-pending { background-color: #e5e7eb; color: #6b7280; }
        .option-card { transition: all 0.2s ease; }
        .option-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .option-card.selected { border-color: #6366f1; background-color: #f5f3ff; }
        .disk-card { transition: all 0.2s ease; }
        .disk-card.selected { border-color: #6366f1; background-color: #f5f3ff; }
        .disk-card.disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
<div class="min-h-screen">
    <!-- Header -->
    <div class="anemone-gradient text-white py-6">
        <div class="max-w-4xl mx-auto px-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <span class="text-3xl">ðŸª¸</span>
                    <h1 class="text-2xl font-bold">Anemone</h1>
                </div>
                <!-- Language Switcher -->
                <div class="flex space-x-2">
                    <a href="?lang=fr" class="px-3 py-1 rounded {{if eq .Lang "fr"}}bg-white/20{{else}}hover:bg-white/10{{end}}">FR</a>
                    <a href="?lang=en" class="px-3 py-1 rounded {{if eq .Lang "en"}}bg-white/20{{else}}hover:bg-white/10{{end}}">EN</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Steps -->
    <div class="max-w-4xl mx-auto px-4 py-6">
        <div class="flex items-center justify-between mb-8">
            <!-- Step 0: Mode -->
            <div class="flex flex-col items-center flex-1">
                <div id="step-indicator-0" class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-medium step-active">1</div>
                <span class="text-xs mt-2 text-center">{{T .Lang "setup_wizard.step.mode"}}</span>
            </div>
            <div class="flex-1 h-1 bg-gray-200 mx-2"><div id="progress-0" class="h-full bg-indigo-500" style="width:0%"></div></div>
            <!-- Step 1: Storage -->
            <div class="flex flex-col items-center flex-1">
                <div id="step-indicator-1" class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-medium step-pending">2</div>
                <span class="text-xs mt-2 text-center">{{T .Lang "setup_wizard.step.storage"}}</span>
            </div>
            <div class="flex-1 h-1 bg-gray-200 mx-2"><div id="progress-1" class="h-full bg-indigo-500" style="width:0%"></div></div>
            <!-- Step 2: Incoming -->
            <div class="flex flex-col items-center flex-1">
                <div id="step-indicator-2" class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-medium step-pending">3</div>
                <span class="text-xs mt-2 text-center">{{T .Lang "setup_wizard.step.incoming"}}</span>
            </div>
            <div class="flex-1 h-1 bg-gray-200 mx-2"><div id="progress-2" class="h-full bg-indigo-500" style="width:0%"></div></div>
            <!-- Step 3: Admin -->
            <div class="flex flex-col items-center flex-1">
                <div id="step-indicator-3" class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-medium step-pending">4</div>
                <span class="text-xs mt-2 text-center">{{T .Lang "setup_wizard.step.admin"}}</span>
            </div>
            <div class="flex-1 h-1 bg-gray-200 mx-2"><div id="progress-3" class="h-full bg-indigo-500" style="width:0%"></div></div>
            <!-- Step 4: Summary -->
            <div class="flex flex-col items-center flex-1">
                <div id="step-indicator-4" class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-medium step-pending">5</div>
                <span class="text-xs mt-2 text-center">{{T .Lang "setup_wizard.step.summary"}}</span>
            </div>
        </div>
    </div>

    <!-- Wizard Content -->
    <div class="max-w-4xl mx-auto px-4 pb-12">
        <!-- Step 0: Mode Selection -->
        <div id="step-0" class="step-content">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">{{T .Lang "setup_wizard.mode.title"}}</h2>
                <p class="text-gray-600 mb-6">{{T .Lang "setup_wizard.mode.description"}}</p>

                <div class="grid gap-4">
                    <!-- New Installation -->
                    <div class="option-card border-2 border-gray-200 rounded-lg p-6 cursor-pointer" onclick="selectMode('new')">
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0 w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-900">{{T .Lang "setup_wizard.mode.new.title"}}</h3>
                                <p class="text-gray-600 mt-1">{{T .Lang "setup_wizard.mode.new.description"}}</p>
                            </div>
                            <div class="flex-shrink-0">
                                <div class="w-6 h-6 border-2 border-gray-300 rounded-full flex items-center justify-center mode-radio" data-mode="new">
                                    <div class="w-3 h-3 bg-indigo-600 rounded-full hidden"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Restore from Backup -->
                    <div class="option-card border-2 border-gray-200 rounded-lg p-6 cursor-pointer" onclick="selectMode('restore')">
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0 w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-900">{{T .Lang "setup_wizard.mode.restore.title"}}</h3>
                                <p class="text-gray-600 mt-1">{{T .Lang "setup_wizard.mode.restore.description"}}</p>
                                <p class="text-sm text-amber-600 mt-2">{{T .Lang "setup_wizard.mode.restore.note"}}</p>
                            </div>
                            <div class="flex-shrink-0">
                                <div class="w-6 h-6 border-2 border-gray-300 rounded-full flex items-center justify-center mode-radio" data-mode="restore">
                                    <div class="w-3 h-3 bg-indigo-600 rounded-full hidden"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Import Existing Pool -->
                    <div class="option-card border-2 border-gray-200 rounded-lg p-6 cursor-pointer" onclick="selectMode('import')">
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0 w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 4H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-2m-4-1v8m0 0l3-3m-3 3L9 8m-5 5h2.586a1 1 0 01.707.293l2.414 2.414a1 1 0 00.707.293h3.172a1 1 0 00.707-.293l2.414-2.414a1 1 0 01.707-.293H20"/>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-900">{{T .Lang "setup_wizard.mode.import.title"}}</h3>
                                <p class="text-gray-600 mt-1">{{T .Lang "setup_wizard.mode.import.description"}}</p>
                            </div>
                            <div class="flex-shrink-0">
                                <div class="w-6 h-6 border-2 border-gray-300 rounded-full flex items-center justify-center mode-radio" data-mode="import">
                                    <div class="w-3 h-3 bg-indigo-600 rounded-full hidden"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex justify-end">
                    <button onclick="nextStep()" id="btn-next-0" class="px-6 py-3 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        {{T .Lang "setup_wizard.next"}}
                        <svg class="inline-block w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 1: Storage Selection -->
        <div id="step-1" class="step-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">{{T .Lang "setup_wizard.storage.title"}}</h2>
                <p class="text-gray-600 mb-6">{{T .Lang "setup_wizard.storage.description"}}</p>

                <div id="storage-options" class="grid gap-4">
                    <p class="text-gray-500 text-center py-4">{{T .Lang "common.loading"}}...</p>
                </div>

                <!-- ZFS New Pool Options (shown when zfs_new is selected) -->
                <div id="zfs-new-options" class="hidden mt-6 p-6 bg-gray-50 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">{{T .Lang "setup_wizard.storage.zfs_config"}}</h3>

                    <div class="grid gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">{{T .Lang "storage.pool_name"}}</label>
                            <input type="text" id="zfs-pool-name" value="anemone" pattern="[a-zA-Z][a-zA-Z0-9_-]*" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">{{T .Lang "storage.vdev_type"}}</label>
                            <select id="zfs-raid-level" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="single">{{T .Lang "setup_wizard.storage.raid.single"}}</option>
                                <option value="mirror">{{T .Lang "setup_wizard.storage.raid.mirror"}}</option>
                                <option value="raidz">{{T .Lang "setup_wizard.storage.raid.raidz1"}}</option>
                                <option value="raidz2">{{T .Lang "setup_wizard.storage.raid.raidz2"}}</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">{{T .Lang "storage.mountpoint"}}</label>
                            <input type="text" id="zfs-mountpoint" placeholder="/srv/anemone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            <p class="text-xs text-gray-500 mt-1">{{T .Lang "storage.mountpoint_help"}}</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">{{T .Lang "storage.select_disks"}}</label>
                            <div id="available-disks" class="space-y-2 max-h-48 overflow-y-auto">
                                <p class="text-gray-500 text-center py-2">{{T .Lang "common.loading"}}...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Custom Path Options -->
                <div id="custom-path-options" class="hidden mt-6 p-6 bg-gray-50 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">{{T .Lang "setup_wizard.storage.custom_config"}}</h3>

                    <div class="grid gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">{{T .Lang "setup_wizard.storage.data_dir"}}</label>
                            <input type="text" id="custom-data-dir" value="/srv/anemone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                            <p class="text-xs text-gray-500 mt-1">{{T .Lang "setup_wizard.storage.data_dir_help"}}</p>
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex justify-between">
                    <button onclick="prevStep()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50">
                        <svg class="inline-block w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                        {{T .Lang "setup_wizard.back"}}
                    </button>
                    <button onclick="nextStep()" id="btn-next-1" class="px-6 py-3 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        {{T .Lang "setup_wizard.next"}}
                        <svg class="inline-block w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 2: Incoming Storage -->
        <div id="step-2" class="step-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">{{T .Lang "setup_wizard.incoming.title"}}</h2>
                <p class="text-gray-600 mb-6">{{T .Lang "setup_wizard.incoming.description"}}</p>

                <div class="grid gap-4">
                    <!-- Same Storage -->
                    <div class="option-card border-2 border-gray-200 rounded-lg p-6 cursor-pointer" onclick="selectIncoming('same')">
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0 w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-900">{{T .Lang "setup_wizard.incoming.same.title"}}</h3>
                                <p class="text-gray-600 mt-1">{{T .Lang "setup_wizard.incoming.same.description"}}</p>
                            </div>
                            <div class="flex-shrink-0">
                                <div class="w-6 h-6 border-2 border-gray-300 rounded-full flex items-center justify-center incoming-radio selected" data-incoming="same">
                                    <div class="w-3 h-3 bg-indigo-600 rounded-full"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Separate Storage -->
                    <div class="option-card border-2 border-gray-200 rounded-lg p-6 cursor-pointer" onclick="selectIncoming('separate')">
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0 w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-900">{{T .Lang "setup_wizard.incoming.separate.title"}}</h3>
                                <p class="text-gray-600 mt-1">{{T .Lang "setup_wizard.incoming.separate.description"}}</p>
                            </div>
                            <div class="flex-shrink-0">
                                <div class="w-6 h-6 border-2 border-gray-300 rounded-full flex items-center justify-center incoming-radio" data-incoming="separate">
                                    <div class="w-3 h-3 bg-indigo-600 rounded-full hidden"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Separate Incoming Options -->
                <div id="incoming-separate-options" class="hidden mt-6 p-6 bg-gray-50 rounded-lg">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">{{T .Lang "setup_wizard.incoming.path"}}</label>
                        <input type="text" id="incoming-path" placeholder="/mnt/backup/incoming" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                        <p class="text-xs text-gray-500 mt-1">{{T .Lang "setup_wizard.incoming.path_help"}}</p>
                    </div>
                </div>

                <div class="mt-8 flex justify-between">
                    <button onclick="prevStep()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50">
                        <svg class="inline-block w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                        {{T .Lang "setup_wizard.back"}}
                    </button>
                    <button onclick="nextStep()" id="btn-next-2" class="px-6 py-3 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700">
                        {{T .Lang "setup_wizard.next"}}
                        <svg class="inline-block w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 3: Admin Account -->
        <div id="step-3" class="step-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">{{T .Lang "setup_wizard.admin.title"}}</h2>
                <p class="text-gray-600 mb-6">{{T .Lang "setup_wizard.admin.description"}}</p>

                <form id="admin-form" class="space-y-6">
                    <div>
                        <label for="admin-username" class="block text-sm font-medium text-gray-700 mb-1">{{T .Lang "setup.admin.username"}}</label>
                        <input type="text" id="admin-username" name="username" required minlength="3" pattern="[a-z][a-z0-9_-]*" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" placeholder="admin">
                        <p class="text-xs text-gray-500 mt-1">{{T .Lang "setup_wizard.admin.username_help"}}</p>
                    </div>

                    <div>
                        <label for="admin-password" class="block text-sm font-medium text-gray-700 mb-1">{{T .Lang "setup.admin.password"}}</label>
                        <input type="password" id="admin-password" name="password" required minlength="8" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                        <p class="text-xs text-gray-500 mt-1">{{T .Lang "setup.admin.password.help"}}</p>
                    </div>

                    <div>
                        <label for="admin-password-confirm" class="block text-sm font-medium text-gray-700 mb-1">{{T .Lang "setup.admin.password_confirm"}}</label>
                        <input type="password" id="admin-password-confirm" name="password_confirm" required minlength="8" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <div>
                        <label for="admin-email" class="block text-sm font-medium text-gray-700 mb-1">{{T .Lang "setup.admin.email"}}</label>
                        <input type="email" id="admin-email" name="email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                        <p class="text-xs text-gray-500 mt-1">{{T .Lang "setup.admin.email.help"}}</p>
                    </div>
                </form>

                <div class="mt-8 flex justify-between">
                    <button onclick="prevStep()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50">
                        <svg class="inline-block w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                        {{T .Lang "setup_wizard.back"}}
                    </button>
                    <button onclick="nextStep()" id="btn-next-3" class="px-6 py-3 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700">
                        {{T .Lang "setup_wizard.next"}}
                        <svg class="inline-block w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 4: Summary & Finalization -->
        <div id="step-4" class="step-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">{{T .Lang "setup_wizard.summary.title"}}</h2>
                <p class="text-gray-600 mb-6">{{T .Lang "setup_wizard.summary.description"}}</p>

                <div class="space-y-4">
                    <!-- Storage Summary -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider mb-2">{{T .Lang "setup_wizard.summary.storage"}}</h3>
                        <div id="summary-storage" class="text-gray-900">-</div>
                    </div>

                    <!-- Incoming Summary -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider mb-2">{{T .Lang "setup_wizard.summary.incoming"}}</h3>
                        <div id="summary-incoming" class="text-gray-900">-</div>
                    </div>

                    <!-- Admin Summary -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider mb-2">{{T .Lang "setup_wizard.summary.admin"}}</h3>
                        <div id="summary-admin" class="text-gray-900">-</div>
                    </div>
                </div>

                <div class="mt-6 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                    <p class="text-amber-800 text-sm">
                        <strong>{{T .Lang "setup_wizard.summary.warning_title"}}</strong>
                        {{T .Lang "setup_wizard.summary.warning_message"}}
                    </p>
                </div>

                <div class="mt-8 flex justify-between">
                    <button onclick="prevStep()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50">
                        <svg class="inline-block w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                        {{T .Lang "setup_wizard.back"}}
                    </button>
                    <button onclick="finalizeSetup()" id="btn-finalize" class="px-8 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700">
                        <svg class="inline-block w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        {{T .Lang "setup_wizard.finalize"}}
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 5: Success -->
        <div id="step-5" class="step-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-8 text-center">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>

                <h2 class="text-2xl font-bold text-gray-900 mb-2">{{T .Lang "setup_wizard.success.title"}}</h2>
                <p class="text-gray-600 mb-8">{{T .Lang "setup_wizard.success.description"}}</p>

                <!-- Encryption Key -->
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-6 mb-6 text-left">
                    <h3 class="text-lg font-semibold text-amber-800 mb-2">{{T .Lang "setup.success.key"}}</h3>
                    <p class="text-sm text-amber-700 mb-4">{{T .Lang "setup.success.key_warning"}}</p>
                    <div class="bg-white border border-amber-300 rounded p-3 font-mono text-sm break-all" id="encryption-key">-</div>
                    <div class="mt-3 flex space-x-2">
                        <button onclick="copyEncryptionKey()" class="px-4 py-2 text-sm bg-amber-100 text-amber-800 rounded hover:bg-amber-200">{{T .Lang "activate.success.copy"}}</button>
                        <button onclick="downloadEncryptionKey()" class="px-4 py-2 text-sm bg-amber-600 text-white rounded hover:bg-amber-700">{{T .Lang "setup.success.download"}}</button>
                    </div>
                </div>

                <!-- Sync Password -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6 text-left">
                    <h3 class="text-lg font-semibold text-blue-800 mb-2">{{T .Lang "setup.success.sync_password"}}</h3>
                    <p class="text-sm text-blue-700 mb-4">{{T .Lang "setup.success.sync_password_help"}}</p>
                    <div class="bg-white border border-blue-300 rounded p-3 font-mono text-sm break-all" id="sync-password">-</div>
                    <button onclick="copySyncPassword()" class="mt-3 px-4 py-2 text-sm bg-blue-100 text-blue-800 rounded hover:bg-blue-200">{{T .Lang "activate.success.copy"}}</button>
                </div>

                <!-- Checkboxes -->
                <div class="text-left space-y-3 mb-8">
                    <label class="flex items-center">
                        <input type="checkbox" id="confirm-key-saved" class="w-5 h-5 text-indigo-600 rounded" onchange="checkConfirmations()">
                        <span class="ml-3 text-gray-700">{{T .Lang "setup.success.checkbox1"}}</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="confirm-understand" class="w-5 h-5 text-indigo-600 rounded" onchange="checkConfirmations()">
                        <span class="ml-3 text-gray-700">{{T .Lang "setup.success.checkbox2"}}</span>
                    </label>
                </div>

                <a href="/login" id="btn-goto-login" class="inline-block px-8 py-3 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 opacity-50 pointer-events-none">
                    {{T .Lang "setup.success.button"}}
                </a>
            </div>
        </div>

        <!-- Step 6: Setup Complete - Restart Required -->
        <div id="step-6" class="step-content {{if ne .CurrentStep 6}}hidden{{end}}">
            <div class="bg-white rounded-xl shadow-lg p-8 text-center">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>

                <h2 class="text-2xl font-bold text-gray-900 mb-2">{{T .Lang "setup_wizard.complete.title"}}</h2>
                <p class="text-gray-600 mb-8">{{T .Lang "setup_wizard.complete.description"}}</p>

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                    <p class="text-blue-800 font-medium mb-2">{{T .Lang "setup_wizard.complete.restart_hint"}}</p>
                    <code class="block bg-white border border-blue-300 rounded p-3 text-sm font-mono text-gray-800">
                        sudo systemctl restart anemone
                    </code>
                </div>

                <div class="text-gray-500 text-sm">
                    <span id="checking-status">{{T .Lang "setup_wizard.complete.checking"}}...</span>
                </div>

                {{if eq .CurrentStep 6}}
                <script>
                    // Auto-check if the server has restarted and normal mode is available
                    (function checkServerStatus() {
                        fetch('/login', { method: 'HEAD' })
                            .then(response => {
                                if (response.ok || response.status === 200) {
                                    window.location.href = '/login';
                                } else {
                                    setTimeout(checkServerStatus, 3000);
                                }
                            })
                            .catch(() => {
                                setTimeout(checkServerStatus, 3000);
                            });
                    })();
                </script>
                {{end}}
            </div>
        </div>

        <!-- Restore Step 1: Upload Backup -->
        <div id="step-restore-upload" class="step-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">{{T .Lang "setup_wizard.restore.upload.title"}}</h2>
                <p class="text-gray-600 mb-6">{{T .Lang "setup_wizard.restore.upload.description"}}</p>

                <div class="space-y-6">
                    <!-- File Upload -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">{{T .Lang "setup_wizard.restore.upload.file_label"}}</label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-indigo-400 transition-colors" id="drop-zone">
                            <input type="file" id="restore-file" accept=".enc" class="hidden" onchange="handleFileSelect(event)">
                            <svg class="w-12 h-12 text-gray-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                            </svg>
                            <p class="text-gray-600 mb-2">{{T .Lang "setup_wizard.restore.upload.drop_file"}}</p>
                            <button type="button" onclick="document.getElementById('restore-file').click()" class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200">
                                {{T .Lang "setup_wizard.restore.upload.browse"}}
                            </button>
                            <p id="selected-file-name" class="text-sm text-indigo-600 mt-3 hidden"></p>
                        </div>
                    </div>

                    <!-- Passphrase -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">{{T .Lang "setup_wizard.restore.upload.passphrase_label"}}</label>
                        <input type="password" id="restore-passphrase" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="{{T .Lang "setup_wizard.restore.upload.passphrase_placeholder"}}">
                        <p class="text-sm text-gray-500 mt-1">{{T .Lang "setup_wizard.restore.upload.passphrase_help"}}</p>
                    </div>

                    <!-- Error message -->
                    <div id="restore-error" class="hidden bg-red-50 border border-red-200 text-red-700 rounded-lg p-4">
                        <p id="restore-error-text"></p>
                    </div>
                </div>

                <div class="mt-8 flex justify-between">
                    <button onclick="backToModeSelection()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50">
                        <svg class="inline-block w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                        {{T .Lang "setup_wizard.back"}}
                    </button>
                    <button onclick="validateRestore()" id="btn-validate-restore" class="px-6 py-3 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        {{T .Lang "setup_wizard.restore.upload.validate"}}
                        <svg class="inline-block w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Restore Step 2: Review & Confirm -->
        <div id="step-restore-confirm" class="step-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">{{T .Lang "setup_wizard.restore.confirm.title"}}</h2>
                <p class="text-gray-600 mb-6">{{T .Lang "setup_wizard.restore.confirm.description"}}</p>

                <!-- Backup Info -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold text-blue-800 mb-4">{{T .Lang "setup_wizard.restore.confirm.backup_info"}}</h3>
                    <dl class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <dt class="text-blue-600">{{T .Lang "setup_wizard.restore.confirm.server_name"}}</dt>
                            <dd class="font-medium text-blue-900" id="restore-server-name">-</dd>
                        </div>
                        <div>
                            <dt class="text-blue-600">{{T .Lang "setup_wizard.restore.confirm.exported_at"}}</dt>
                            <dd class="font-medium text-blue-900" id="restore-exported-at">-</dd>
                        </div>
                        <div>
                            <dt class="text-blue-600">{{T .Lang "setup_wizard.restore.confirm.users_count"}}</dt>
                            <dd class="font-medium text-blue-900" id="restore-users-count">-</dd>
                        </div>
                        <div>
                            <dt class="text-blue-600">{{T .Lang "setup_wizard.restore.confirm.peers_count"}}</dt>
                            <dd class="font-medium text-blue-900" id="restore-peers-count">-</dd>
                        </div>
                    </dl>
                </div>

                <!-- Users List -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">{{T .Lang "setup_wizard.restore.confirm.users_list"}}</h3>
                    <div id="restore-users-list" class="bg-gray-50 rounded-lg p-4 max-h-40 overflow-y-auto">
                        <p class="text-gray-500">-</p>
                    </div>
                </div>

                <!-- Peers List -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">{{T .Lang "setup_wizard.restore.confirm.peers_list"}}</h3>
                    <div id="restore-peers-list" class="bg-gray-50 rounded-lg p-4 max-h-40 overflow-y-auto">
                        <p class="text-gray-500">-</p>
                    </div>
                </div>

                <!-- Warning -->
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
                    <div class="flex">
                        <svg class="w-5 h-5 text-amber-600 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        <p class="text-sm text-amber-700">{{T .Lang "setup_wizard.restore.confirm.warning"}}</p>
                    </div>
                </div>

                <div class="mt-8 flex justify-between">
                    <button onclick="showRestoreUpload()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50">
                        <svg class="inline-block w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                        {{T .Lang "setup_wizard.back"}}
                    </button>
                    <button onclick="executeRestore()" id="btn-execute-restore" class="px-6 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700">
                        <svg class="inline-block w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        {{T .Lang "setup_wizard.restore.confirm.execute"}}
                    </button>
                </div>
            </div>
        </div>

        <!-- Restore Step 3: Success -->
        <div id="step-restore-success" class="step-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-8 text-center">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>

                <h2 class="text-2xl font-bold text-gray-900 mb-2">{{T .Lang "setup_wizard.restore.success.title"}}</h2>
                <p class="text-gray-600 mb-6">{{T .Lang "setup_wizard.restore.success.description"}}</p>

                <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-8 text-left">
                    <h3 class="text-lg font-semibold text-green-800 mb-3">{{T .Lang "setup_wizard.restore.success.summary"}}</h3>
                    <ul class="space-y-2 text-green-700">
                        <li class="flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span id="restore-success-users">-</span>
                        </li>
                        <li class="flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span id="restore-success-peers">-</span>
                        </li>
                        <li class="flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            {{T .Lang "setup_wizard.restore.success.config_restored"}}
                        </li>
                    </ul>
                </div>

                <a href="/login" class="inline-block px-8 py-3 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700">
                    {{T .Lang "setup_wizard.restore.success.login"}}
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg p-8 text-center">
        <div class="animate-spin w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full mx-auto mb-4"></div>
        <p class="text-gray-700" id="loading-message">{{T .Lang "common.loading"}}...</p>
    </div>
</div>

<script>
// State
let currentStep = 0;
let selectedMode = null;
let selectedStorage = null;
let selectedIncoming = 'same';
let storageOptions = [];
let availableDisks = [];
let setupResult = null;

const translations = {
    loading: "{{T .Lang "common.loading"}}...",
    error: "{{T .Lang "common.error"}}",
    configuring_storage: "{{T .Lang "setup_wizard.loading.configuring_storage"}}",
    creating_admin: "{{T .Lang "setup_wizard.loading.creating_admin"}}",
    finalizing: "{{T .Lang "setup_wizard.loading.finalizing"}}",
    default_storage: "{{T .Lang "setup_wizard.summary.default_storage"}}",
    zfs_existing: "{{T .Lang "setup_wizard.summary.zfs_existing"}}",
    zfs_new: "{{T .Lang "setup_wizard.summary.zfs_new"}}",
    custom_path: "{{T .Lang "setup_wizard.summary.custom_path"}}",
    same_storage: "{{T .Lang "setup_wizard.summary.same_storage"}}",
    separate_path: "{{T .Lang "setup_wizard.summary.separate_path"}}",
    admin_user: "{{T .Lang "setup_wizard.summary.admin_user"}}",
    passwords_mismatch: "{{T .Lang "setup.errors.password_mismatch"}}",
    password_too_short: "{{T .Lang "setup.errors.password_length"}}",
    username_required: "{{T .Lang "setup.errors.required"}}",
    select_disks: "{{T .Lang "storage.select_at_least_one_disk"}}"
};

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadStorageOptions();
});

// Mode selection
function selectMode(mode) {
    selectedMode = mode;
    document.querySelectorAll('.mode-radio').forEach(el => {
        el.classList.remove('selected');
        el.querySelector('div').classList.add('hidden');
        el.closest('.option-card').classList.remove('selected');
    });
    const radio = document.querySelector(`.mode-radio[data-mode="${mode}"]`);
    radio.classList.add('selected');
    radio.querySelector('div').classList.remove('hidden');
    radio.closest('.option-card').classList.add('selected');
    document.getElementById('btn-next-0').disabled = false;
}

// Storage selection
function selectStorage(type, path) {
    selectedStorage = { type, path };
    document.querySelectorAll('.storage-option').forEach(el => {
        el.classList.remove('selected');
    });
    document.querySelector(`.storage-option[data-type="${type}"]`)?.classList.add('selected');

    // Show/hide additional options
    document.getElementById('zfs-new-options').classList.add('hidden');
    document.getElementById('custom-path-options').classList.add('hidden');

    if (type === 'zfs_new') {
        document.getElementById('zfs-new-options').classList.remove('hidden');
        loadAvailableDisks();
    } else if (type === 'custom') {
        document.getElementById('custom-path-options').classList.remove('hidden');
    }

    updateStorageNextButton();
}

// Incoming selection
function selectIncoming(type) {
    selectedIncoming = type;
    document.querySelectorAll('.incoming-radio').forEach(el => {
        el.classList.remove('selected');
        el.querySelector('div').classList.add('hidden');
        el.closest('.option-card').classList.remove('selected');
    });
    const radio = document.querySelector(`.incoming-radio[data-incoming="${type}"]`);
    radio.classList.add('selected');
    radio.querySelector('div').classList.remove('hidden');
    radio.closest('.option-card').classList.add('selected');

    if (type === 'separate') {
        document.getElementById('incoming-separate-options').classList.remove('hidden');
    } else {
        document.getElementById('incoming-separate-options').classList.add('hidden');
    }
}

// Disk selection for ZFS
function toggleDisk(path) {
    const diskCard = document.querySelector(`.disk-card[data-path="${path}"]`);
    if (diskCard.classList.contains('disabled')) return;

    diskCard.classList.toggle('selected');
    updateStorageNextButton();
}

function updateStorageNextButton() {
    let enabled = false;

    if (selectedStorage) {
        if (selectedStorage.type === 'zfs_new') {
            const selectedDisks = document.querySelectorAll('.disk-card.selected:not(.disabled)');
            enabled = selectedDisks.length > 0 && document.getElementById('zfs-pool-name').value;
        } else if (selectedStorage.type === 'custom') {
            enabled = document.getElementById('custom-data-dir').value.trim() !== '';
        } else {
            enabled = true;
        }
    }

    document.getElementById('btn-next-1').disabled = !enabled;
}

// Load storage options from API
async function loadStorageOptions() {
    try {
        const resp = await fetch('/setup/wizard/storage/options');
        storageOptions = await resp.json();
        renderStorageOptions();
    } catch (err) {
        console.error('Error loading storage options:', err);
        document.getElementById('storage-options').innerHTML = `<p class="text-red-500 text-center py-4">${translations.error}</p>`;
    }
}

function renderStorageOptions() {
    const container = document.getElementById('storage-options');
    let html = '';

    storageOptions.forEach(opt => {
        const icon = getStorageIcon(opt.type);
        html += `
            <div class="option-card storage-option border-2 border-gray-200 rounded-lg p-6 cursor-pointer" data-type="${opt.type}" onclick="selectStorage('${opt.type}', '${opt.path || ''}')">
                <div class="flex items-start space-x-4">
                    <div class="flex-shrink-0 w-12 h-12 ${icon.bg} rounded-lg flex items-center justify-center">
                        ${icon.svg}
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-900">${opt.name}</h3>
                        <p class="text-gray-600 mt-1">${opt.description}</p>
                        ${opt.path ? `<p class="text-sm text-indigo-600 mt-1 font-mono">${opt.path}</p>` : ''}
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

function getStorageIcon(type) {
    switch(type) {
        case 'default':
            return { bg: 'bg-green-100', svg: '<svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>' };
        case 'zfs_existing':
            return { bg: 'bg-blue-100', svg: '<svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/></svg>' };
        case 'zfs_new':
            return { bg: 'bg-purple-100', svg: '<svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>' };
        case 'custom':
            return { bg: 'bg-gray-100', svg: '<svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>' };
        default:
            return { bg: 'bg-gray-100', svg: '<svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7"/></svg>' };
    }
}

// Load available disks for ZFS
async function loadAvailableDisks() {
    try {
        const resp = await fetch('/setup/wizard/storage/disks');
        availableDisks = await resp.json();
        renderAvailableDisks();
    } catch (err) {
        console.error('Error loading disks:', err);
        document.getElementById('available-disks').innerHTML = `<p class="text-red-500">${translations.error}</p>`;
    }
}

function renderAvailableDisks() {
    const container = document.getElementById('available-disks');
    if (!availableDisks || availableDisks.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-2">{{T .Lang "storage.no_available_disks"}}</p>';
        return;
    }

    let html = '';
    availableDisks.forEach(disk => {
        const disabled = disk.in_use ? 'disabled' : '';
        const disabledClass = disk.in_use ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer';
        html += `
            <div class="disk-card border rounded-lg p-3 ${disabledClass} ${disabled}" data-path="${disk.path}" onclick="toggleDisk('${disk.path}')">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <input type="checkbox" class="w-4 h-4 text-indigo-600 rounded" ${disabled} onclick="event.stopPropagation()">
                        <div>
                            <div class="font-medium text-gray-900">${disk.path}</div>
                            <div class="text-sm text-gray-500">${disk.model || disk.name} - ${disk.size_human}</div>
                        </div>
                    </div>
                    <span class="px-2 py-1 text-xs rounded ${disk.type === 'nvme' ? 'bg-purple-100 text-purple-800' : disk.type === 'ssd' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">${disk.type.toUpperCase()}</span>
                </div>
                ${disk.in_use ? '<p class="text-xs text-amber-600 mt-1">{{T .Lang "setup_wizard.storage.disk_in_use"}}</p>' : ''}
            </div>
        `;
    });
    container.innerHTML = html;
}

// Step navigation
function nextStep() {
    if (currentStep === 0) {
        // Mode selected, go to storage
        currentStep = 1;
    } else if (currentStep === 1) {
        // Storage configured, go to incoming
        currentStep = 2;
    } else if (currentStep === 2) {
        // Incoming configured, go to admin
        currentStep = 3;
    } else if (currentStep === 3) {
        // Admin form - validate and go to summary
        if (!validateAdminForm()) return;
        updateSummary();
        currentStep = 4;
    }

    showStep(currentStep);
}

function prevStep() {
    if (currentStep > 0) {
        currentStep--;
        showStep(currentStep);
    }
}

function showStep(step) {
    // Hide all steps
    document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
    // Show current step
    document.getElementById(`step-${step}`).classList.remove('hidden');

    // Update progress indicators
    for (let i = 0; i < 5; i++) {
        const indicator = document.getElementById(`step-indicator-${i}`);
        indicator.classList.remove('step-active', 'step-completed', 'step-pending');

        if (i < step) {
            indicator.classList.add('step-completed');
        } else if (i === step) {
            indicator.classList.add('step-active');
        } else {
            indicator.classList.add('step-pending');
        }

        // Update progress bars
        if (i < 4) {
            const progress = document.getElementById(`progress-${i}`);
            progress.style.width = i < step ? '100%' : '0%';
        }
    }
}

function validateAdminForm() {
    const username = document.getElementById('admin-username').value.trim();
    const password = document.getElementById('admin-password').value;
    const passwordConfirm = document.getElementById('admin-password-confirm').value;

    if (!username || username.length < 3) {
        alert(translations.username_required);
        return false;
    }

    if (password.length < 8) {
        alert(translations.password_too_short);
        return false;
    }

    if (password !== passwordConfirm) {
        alert(translations.passwords_mismatch);
        return false;
    }

    return true;
}

function updateSummary() {
    // Storage summary
    let storageSummary = '';
    if (selectedStorage) {
        switch (selectedStorage.type) {
            case 'default':
                storageSummary = `${translations.default_storage}: /srv/anemone`;
                break;
            case 'zfs_existing':
                storageSummary = `${translations.zfs_existing}: ${selectedStorage.path}`;
                break;
            case 'zfs_new':
                const poolName = document.getElementById('zfs-pool-name').value;
                const raidLevel = document.getElementById('zfs-raid-level').value;
                const selectedDisks = Array.from(document.querySelectorAll('.disk-card.selected:not(.disabled)')).map(el => el.dataset.path);
                storageSummary = `${translations.zfs_new}: ${poolName} (${raidLevel}) - ${selectedDisks.length} disque(s)`;
                break;
            case 'custom':
                storageSummary = `${translations.custom_path}: ${document.getElementById('custom-data-dir').value}`;
                break;
        }
    }
    document.getElementById('summary-storage').textContent = storageSummary;

    // Incoming summary
    let incomingSummary = selectedIncoming === 'same'
        ? translations.same_storage
        : `${translations.separate_path}: ${document.getElementById('incoming-path').value || '-'}`;
    document.getElementById('summary-incoming').textContent = incomingSummary;

    // Admin summary
    const username = document.getElementById('admin-username').value;
    const email = document.getElementById('admin-email').value;
    document.getElementById('summary-admin').textContent = `${translations.admin_user}: ${username}${email ? ` (${email})` : ''}`;
}

// Finalize setup
async function finalizeSetup() {
    showLoading(translations.configuring_storage);

    try {
        // 1. Configure storage
        const storageConfig = buildStorageConfig();
        const storageResp = await fetch('/setup/wizard/storage/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(storageConfig)
        });

        if (!storageResp.ok) {
            const error = await storageResp.text();
            throw new Error(error);
        }

        // 2. Create admin account
        showLoading(translations.creating_admin);
        const adminConfig = {
            username: document.getElementById('admin-username').value.trim(),
            password: document.getElementById('admin-password').value,
            email: document.getElementById('admin-email').value.trim()
        };

        const adminResp = await fetch('/setup/wizard/admin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(adminConfig)
        });

        if (!adminResp.ok) {
            const error = await adminResp.text();
            throw new Error(error);
        }

        const adminResult = await adminResp.json();
        setupResult = adminResult;

        // 3. Finalize
        showLoading(translations.finalizing);
        const finalResp = await fetch('/setup/wizard/finalize', {
            method: 'POST'
        });

        if (!finalResp.ok) {
            const error = await finalResp.text();
            throw new Error(error);
        }

        // Show success
        hideLoading();
        document.getElementById('encryption-key').textContent = setupResult.encryption_key || '-';
        document.getElementById('sync-password').textContent = setupResult.sync_password || '-';
        currentStep = 5;
        showStep(5);

    } catch (err) {
        hideLoading();
        alert(`${translations.error}: ${err.message}`);
    }
}

function buildStorageConfig() {
    const config = {
        storage_type: selectedStorage?.type || 'default'
    };

    if (selectedStorage?.type === 'zfs_existing') {
        // Extract pool name from path (e.g., /poolname -> poolname)
        const match = selectedStorage.path.match(/^\/([^\/]+)/);
        config.zfs_pool_name = match ? match[1] : selectedStorage.path;
    } else if (selectedStorage?.type === 'zfs_new') {
        config.zfs_pool_name = document.getElementById('zfs-pool-name').value;
        config.zfs_raid_level = document.getElementById('zfs-raid-level').value;
        config.zfs_mountpoint = document.getElementById('zfs-mountpoint').value;
        config.zfs_devices = Array.from(document.querySelectorAll('.disk-card.selected:not(.disabled)')).map(el => el.dataset.path);
    } else if (selectedStorage?.type === 'custom') {
        config.data_dir = document.getElementById('custom-data-dir').value;
    }

    // Incoming storage
    config.separate_incoming = selectedIncoming === 'separate';
    if (selectedIncoming === 'separate') {
        config.incoming_dir = document.getElementById('incoming-path').value;
    }

    return config;
}

// Loading overlay
function showLoading(message) {
    document.getElementById('loading-message').textContent = message || translations.loading;
    document.getElementById('loading-overlay').classList.remove('hidden');
}

function hideLoading() {
    document.getElementById('loading-overlay').classList.add('hidden');
}

// Success page helpers
function copyEncryptionKey() {
    const key = document.getElementById('encryption-key').textContent;
    navigator.clipboard.writeText(key);
}

function copySyncPassword() {
    const password = document.getElementById('sync-password').textContent;
    navigator.clipboard.writeText(password);
}

function downloadEncryptionKey() {
    const key = document.getElementById('encryption-key').textContent;
    const username = document.getElementById('admin-username').value;
    const blob = new Blob([`Anemone Encryption Key\n\nUser: ${username}\nKey: ${key}\n\nKeep this file safe!`], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `anemone-key-${username}.txt`;
    a.click();
    URL.revokeObjectURL(url);
}

function checkConfirmations() {
    const keySaved = document.getElementById('confirm-key-saved').checked;
    const understand = document.getElementById('confirm-understand').checked;
    const btn = document.getElementById('btn-goto-login');

    if (keySaved && understand) {
        btn.classList.remove('opacity-50', 'pointer-events-none');
    } else {
        btn.classList.add('opacity-50', 'pointer-events-none');
    }
}

// Add event listeners for ZFS form inputs
document.getElementById('zfs-pool-name')?.addEventListener('input', updateStorageNextButton);
document.getElementById('custom-data-dir')?.addEventListener('input', updateStorageNextButton);

// =============================================
// RESTORE FLOW FUNCTIONS
// =============================================

let restoreFile = null;
let restoreResult = null;

// Handle file selection
function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
        restoreFile = file;
        document.getElementById('selected-file-name').textContent = file.name;
        document.getElementById('selected-file-name').classList.remove('hidden');
        updateRestoreValidateButton();
    }
}

// Enable/disable validate button
function updateRestoreValidateButton() {
    const hasFile = restoreFile !== null;
    const hasPassphrase = document.getElementById('restore-passphrase').value.trim() !== '';
    document.getElementById('btn-validate-restore').disabled = !(hasFile && hasPassphrase);
}

// Listen for passphrase input
document.getElementById('restore-passphrase')?.addEventListener('input', updateRestoreValidateButton);

// Validate and decrypt backup
async function validateRestore() {
    const passphrase = document.getElementById('restore-passphrase').value.trim();
    if (!restoreFile || !passphrase) return;

    showLoading(translations.validating_backup || 'Validating backup...');
    document.getElementById('restore-error').classList.add('hidden');

    try {
        const formData = new FormData();
        formData.append('backup', restoreFile);
        formData.append('passphrase', passphrase);

        const resp = await fetch('/setup/wizard/restore/validate', {
            method: 'POST',
            body: formData
        });

        const result = await resp.json();
        hideLoading();

        if (!result.valid) {
            // Show error
            document.getElementById('restore-error-text').textContent =
                result.error === 'invalid_passphrase'
                    ? (translations.invalid_passphrase || 'Invalid passphrase. Please check your passphrase and try again.')
                    : (result.error || 'Failed to validate backup');
            document.getElementById('restore-error').classList.remove('hidden');
            return;
        }

        // Store result and show confirm step
        restoreResult = result;
        showRestoreConfirm(result);

    } catch (err) {
        hideLoading();
        document.getElementById('restore-error-text').textContent = err.message;
        document.getElementById('restore-error').classList.remove('hidden');
    }
}

// Show restore confirm step with backup info
function showRestoreConfirm(result) {
    // Populate backup info
    document.getElementById('restore-server-name').textContent = result.server_name || '-';
    document.getElementById('restore-exported-at').textContent = result.exported_at || '-';
    document.getElementById('restore-users-count').textContent = result.users_count || 0;
    document.getElementById('restore-peers-count').textContent = result.peers_count || 0;

    // Populate users list
    const usersContainer = document.getElementById('restore-users-list');
    if (result.users && result.users.length > 0) {
        usersContainer.innerHTML = result.users.map(u => `
            <div class="flex items-center justify-between py-2 border-b border-gray-200 last:border-0">
                <span class="font-medium">${u.username}</span>
                <span class="text-sm text-gray-500">${u.is_admin ? 'ðŸ‘‘ Admin' : ''} ${u.email || ''}</span>
            </div>
        `).join('');
    } else {
        usersContainer.innerHTML = '<p class="text-gray-500">No users</p>';
    }

    // Populate peers list
    const peersContainer = document.getElementById('restore-peers-list');
    if (result.peers && result.peers.length > 0) {
        peersContainer.innerHTML = result.peers.map(p => `
            <div class="flex items-center justify-between py-2 border-b border-gray-200 last:border-0">
                <span class="font-medium">${p.name}</span>
                <span class="text-sm text-gray-500">${p.address}:${p.port}</span>
            </div>
        `).join('');
    } else {
        peersContainer.innerHTML = '<p class="text-gray-500">No peers</p>';
    }

    // Show confirm step
    hideAllSteps();
    document.getElementById('step-restore-confirm').classList.remove('hidden');
}

// Execute the restore
async function executeRestore() {
    showLoading(translations.restoring || 'Restoring server configuration...');

    try {
        const resp = await fetch('/setup/wizard/restore/execute', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                data_dir: '/srv/anemone' // Use default for now
            })
        });

        if (!resp.ok) {
            const error = await resp.text();
            throw new Error(error);
        }

        const result = await resp.json();
        hideLoading();

        // Show success
        document.getElementById('restore-success-users').textContent =
            `${result.users_count} ${translations.users_restored || 'users restored'}`;
        document.getElementById('restore-success-peers').textContent =
            `${result.peers_count} ${translations.peers_restored || 'peers restored'}`;

        hideAllSteps();
        document.getElementById('step-restore-success').classList.remove('hidden');

    } catch (err) {
        hideLoading();
        alert((translations.restore_failed || 'Restore failed') + ': ' + err.message);
    }
}

// Navigation helpers for restore flow
function showRestoreUpload() {
    hideAllSteps();
    document.getElementById('step-restore-upload').classList.remove('hidden');
}

function backToModeSelection() {
    selectedMode = null;
    currentStep = 0;
    restoreFile = null;
    restoreResult = null;
    document.getElementById('restore-file').value = '';
    document.getElementById('restore-passphrase').value = '';
    document.getElementById('selected-file-name').classList.add('hidden');
    document.getElementById('restore-error').classList.add('hidden');
    document.querySelectorAll('.mode-radio').forEach(el => {
        el.classList.remove('selected');
        el.querySelector('div').classList.add('hidden');
        el.closest('.option-card').classList.remove('selected');
    });
    document.getElementById('btn-next-0').disabled = true;
    showStep(0);
}

function hideAllSteps() {
    document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
}

// Modify nextStep to handle restore mode
const originalNextStep = nextStep;
nextStep = function() {
    if (currentStep === 0 && selectedMode === 'restore') {
        // Go to restore upload step
        hideAllSteps();
        document.getElementById('step-restore-upload').classList.remove('hidden');
        return;
    }
    originalNextStep();
};

// Drag and drop support for file upload
const dropZone = document.getElementById('drop-zone');
if (dropZone) {
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('border-indigo-400', 'bg-indigo-50');
    });
    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-indigo-400', 'bg-indigo-50');
    });
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-indigo-400', 'bg-indigo-50');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            document.getElementById('restore-file').files = files;
            handleFileSelect({ target: { files: files } });
        }
    });
}
</script>
</body>
</html>
