{{/* Anemone v2 - Backups consolidated page with tabs */}}
{{define "content"}}
{{if .Flash}}
<div style="padding:0.75rem 1rem;border-radius:0.5rem;margin-bottom:1rem;font-size:0.8125rem;
    {{if eq .FlashType "success"}}background:rgba(34,197,94,0.1);color:var(--success);border:1px solid rgba(34,197,94,0.2);
    {{else if eq .FlashType "error"}}background:rgba(239,68,68,0.1);color:var(--error);border:1px solid rgba(239,68,68,0.2);
    {{else}}background:rgba(99,102,241,0.1);color:var(--info);border:1px solid rgba(99,102,241,0.2);{{end}}">
    {{.Flash}}
</div>
{{end}}
<!-- Tab navigation -->
<div class="v2-tabs" id="backupTabs">
    <button class="v2-tab{{if eq .ActiveTab "recent"}} active{{end}}" data-tab="recent" onclick="switchTab('recent')">
        <svg style="display:inline;width:16px;height:16px;vertical-align:middle;margin-right:4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        {{T .Lang "v2.backups.recent.tab"}}
    </button>
    <button class="v2-tab{{if eq .ActiveTab "usb"}} active{{end}}" data-tab="usb" onclick="switchTab('usb')">
        <svg style="display:inline;width:16px;height:16px;vertical-align:middle;margin-right:4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M9 1v3"/><path d="M15 1v3"/><path d="M9 20v3"/><path d="M15 20v3"/></svg>
        USB
    </button>
    <button class="v2-tab{{if eq .ActiveTab "cloud"}} active{{end}}" data-tab="cloud" onclick="switchTab('cloud')">
        <svg style="display:inline;width:16px;height:16px;vertical-align:middle;margin-right:4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>
        Cloud
    </button>
    <button class="v2-tab{{if eq .ActiveTab "p2p"}} active{{end}}" data-tab="p2p" onclick="switchTab('p2p')">
        <svg style="display:inline;width:16px;height:16px;vertical-align:middle;margin-right:4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></svg>
        P2P Sync
    </button>
    <button class="v2-tab{{if eq .ActiveTab "incoming"}} active{{end}}" data-tab="incoming" onclick="switchTab('incoming')">
        <svg style="display:inline;width:16px;height:16px;vertical-align:middle;margin-right:4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        Incoming
    </button>
    <button class="v2-tab{{if eq .ActiveTab "server"}} active{{end}}" data-tab="server" onclick="switchTab('server')">
        <svg style="display:inline;width:16px;height:16px;vertical-align:middle;margin-right:4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="8" rx="2"/><rect x="2" y="14" width="20" height="8" rx="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/></svg>
        Server
    </button>
</div>

<!-- ===== Recent Tab ===== -->
<div class="v2-tab-panel{{if eq .ActiveTab "recent"}} active{{end}}" id="tab-recent">
    <div style="font-size:0.9375rem;font-weight:700;color:var(--text-primary);margin-bottom:1rem;">{{T .Lang "v2.backups.recent.title"}}</div>

    {{if .RecentBackups}}
    <div class="v2-card" style="padding:0;overflow:hidden;">
        <table class="v2-table">
            <thead>
                <tr>
                    <th>{{T .Lang "v2.backups.recent.type"}}</th>
                    <th>{{T .Lang "v2.backups.recent.name"}}</th>
                    <th>{{T .Lang "v2.backups.recent.status"}}</th>
                    <th>{{T .Lang "v2.backups.recent.date"}}</th>
                </tr>
            </thead>
            <tbody>
                {{range .RecentBackups}}
                <tr>
                    <td>
                        {{if eq .Type "usb"}}
                            <span class="v2-badge" style="background:rgba(245,158,11,0.1);color:#f59e0b;">{{T $.Lang "v2.backups.recent.type_usb"}}</span>
                        {{else if eq .Type "cloud"}}
                            <span class="v2-badge" style="background:rgba(59,130,246,0.1);color:#3b82f6;">{{T $.Lang "v2.backups.recent.type_cloud"}}</span>
                        {{else if eq .Type "p2p"}}
                            <span class="v2-badge" style="background:rgba(168,85,247,0.1);color:#a855f7;">{{T $.Lang "v2.backups.recent.type_p2p"}}</span>
                        {{else if eq .Type "server"}}
                            <span class="v2-badge" style="background:rgba(34,197,94,0.1);color:#22c55e;">{{T $.Lang "v2.backups.recent.type_server"}}</span>
                        {{end}}
                    </td>
                    <td style="font-weight:600;">{{.Name}}</td>
                    <td>
                        {{if eq .Status "success"}}
                            <span class="v2-badge v2-badge-success">{{T $.Lang "v2.backups.status.success"}}</span>
                        {{else if eq .Status "error"}}
                            <span class="v2-badge v2-badge-error">{{T $.Lang "v2.backups.status.error"}}</span>
                        {{else if eq .Status "running"}}
                            <span class="v2-badge v2-badge-info">{{T $.Lang "v2.backups.status.running"}}</span>
                        {{else}}
                            <span class="v2-badge">{{.Status}}</span>
                        {{end}}
                    </td>
                    <td style="font-size:0.8125rem;color:var(--text-secondary);">{{.Time}}</td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
    {{else}}
    <div class="v2-card v2-empty">
        <svg class="v2-empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        <div style="font-size:0.875rem;">{{T .Lang "v2.backups.recent.empty"}}</div>
    </div>
    {{end}}
</div>

<!-- ===== USB Tab ===== -->
<div class="v2-tab-panel{{if eq .ActiveTab "usb"}} active{{end}}" id="tab-usb">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
        <div style="font-size:0.9375rem;font-weight:700;color:var(--text-primary);">{{T .Lang "v2.backups.usb.title"}}</div>
        <a href="/admin/usb-backup/add" class="v2-btn v2-btn-primary v2-btn-sm">+ {{T .Lang "v2.backups.add"}}</a>
    </div>

    {{if .USBBackups}}
    <div class="v2-card" style="padding:0;overflow:hidden;">
        <table class="v2-table">
            <thead>
                <tr>
                    <th>{{T .Lang "v2.backups.usb.name"}}</th>
                    <th>{{T .Lang "v2.backups.usb.device"}}</th>
                    <th>{{T .Lang "v2.backups.usb.status"}}</th>
                    <th>{{T .Lang "v2.backups.usb.last_sync"}}</th>
                    <th>{{T .Lang "v2.backups.actions"}}</th>
                </tr>
            </thead>
            <tbody>
                {{range .USBBackups}}
                <tr>
                    <td style="font-weight:600;">{{.Name}}</td>
                    <td><code style="font-size:0.8125rem;color:var(--text-secondary);">{{.DevicePath}}</code></td>
                    <td>
                        {{if .IsMounted}}
                            <span class="v2-badge v2-badge-success">{{T $.Lang "v2.backups.usb.mounted"}}</span>
                        {{else}}
                            <span class="v2-badge v2-badge-warning">{{T $.Lang "v2.backups.usb.unmounted"}}</span>
                        {{end}}
                    </td>
                    <td style="font-size:0.8125rem;color:var(--text-secondary);">{{.LastSync}}</td>
                    <td>
                        <div style="display:flex;gap:0.5rem;">
                            {{if .IsMounted}}
                            <form method="POST" action="/admin/usb-backup/{{.ID}}/sync" style="display:inline;">
                                <button type="submit" class="v2-btn v2-btn-primary v2-btn-sm">Sync</button>
                            </form>
                            {{end}}
                            <a href="/admin/usb-backup/{{.ID}}/edit" class="v2-btn v2-btn-secondary v2-btn-sm">{{T $.Lang "v2.backups.edit"}}</a>
                        </div>
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
    {{else}}
    <div class="v2-card v2-empty">
        <svg class="v2-empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M9 1v3"/><path d="M15 1v3"/></svg>
        <div style="font-size:0.875rem;margin-bottom:0.5rem;">{{T .Lang "v2.backups.usb.empty"}}</div>
        <a href="/admin/usb-backup/add" class="v2-btn v2-btn-primary v2-btn-sm">+ {{T .Lang "v2.backups.add"}}</a>
    </div>
    {{end}}

    {{if .USBDrives}}
    <div style="margin-top:1rem;">
        <div style="font-size:0.8125rem;font-weight:600;color:var(--text-secondary);margin-bottom:0.5rem;">{{T .Lang "v2.backups.usb.available_drives"}}</div>
        <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
            {{range .USBDrives}}
            <div class="v2-card" style="padding:0.75rem;display:flex;align-items:center;gap:0.5rem;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>
                <span style="font-size:0.8125rem;">{{.Name}}</span>
                <span style="font-size:0.75rem;color:var(--text-muted);">{{.Size}}</span>
            </div>
            {{end}}
        </div>
    </div>
    {{end}}
</div>

<!-- ===== Cloud Tab ===== -->
<div class="v2-tab-panel{{if eq .ActiveTab "cloud"}} active{{end}}" id="tab-cloud">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
        <div style="font-size:0.9375rem;font-weight:700;color:var(--text-primary);">{{T .Lang "v2.backups.cloud.title"}}</div>
        <a href="/admin/rclone/add" class="v2-btn v2-btn-primary v2-btn-sm">+ {{T .Lang "v2.backups.add"}}</a>
    </div>

    {{if .RcloneConfigs}}
    <div class="v2-card" style="padding:0;overflow:hidden;">
        <table class="v2-table">
            <thead>
                <tr>
                    <th>{{T .Lang "v2.backups.cloud.name"}}</th>
                    <th>{{T .Lang "v2.backups.cloud.type"}}</th>
                    <th>{{T .Lang "v2.backups.cloud.destination"}}</th>
                    <th>{{T .Lang "v2.backups.cloud.status"}}</th>
                    <th>{{T .Lang "v2.backups.cloud.last_sync"}}</th>
                    <th>{{T .Lang "v2.backups.actions"}}</th>
                </tr>
            </thead>
            <tbody>
                {{range .RcloneConfigs}}
                <tr>
                    <td style="font-weight:600;">{{.Name}}</td>
                    <td>
                        {{if eq .ProviderType "s3"}}
                            <span class="v2-badge" style="background:rgba(245,158,11,0.1);color:#f59e0b;">S3</span>
                        {{else if eq .ProviderType "webdav"}}
                            <span class="v2-badge" style="background:rgba(59,130,246,0.1);color:#3b82f6;">WebDAV</span>
                        {{else if eq .ProviderType "remote"}}
                            <span class="v2-badge" style="background:rgba(168,85,247,0.1);color:#a855f7;">Remote</span>
                        {{else}}
                            <span class="v2-badge" style="background:rgba(34,197,94,0.1);color:#22c55e;">SFTP</span>
                        {{end}}
                        {{if .Encrypted}}
                            <svg style="display:inline;width:14px;height:14px;vertical-align:middle;margin-left:2px;" viewBox="0 0 24 24" fill="none" stroke="var(--warning)" stroke-width="2" title="{{T $.Lang "v2.backups.cloud.encrypted"}}"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                        {{end}}
                    </td>
                    <td style="font-size:0.8125rem;color:var(--text-secondary);">{{.Destination}}:{{.RemotePath}}</td>
                    <td>
                        {{if not .Enabled}}
                            <span class="v2-badge v2-badge-warning">{{T $.Lang "v2.backups.cloud.disabled"}}</span>
                        {{else if eq .LastStatus "running"}}
                            <span class="v2-badge v2-badge-info">{{T $.Lang "v2.backups.status.running"}}</span>
                        {{else if eq .LastStatus "success"}}
                            <span class="v2-badge v2-badge-success">{{T $.Lang "v2.backups.status.success"}}</span>
                        {{else if eq .LastStatus "error"}}
                            <span class="v2-badge v2-badge-error">{{T $.Lang "v2.backups.status.error"}}</span>
                        {{else}}
                            <span class="v2-badge">{{T $.Lang "v2.backups.cloud.enabled"}}</span>
                        {{end}}
                    </td>
                    <td style="font-size:0.8125rem;color:var(--text-secondary);">{{.LastSync}}</td>
                    <td>
                        <div style="display:flex;gap:0.5rem;">
                            <form method="POST" action="/admin/rclone/{{.ID}}/sync" style="display:inline;">
                                <button type="submit" class="v2-btn v2-btn-primary v2-btn-sm">Sync</button>
                            </form>
                            <a href="/admin/rclone/{{.ID}}" class="v2-btn v2-btn-secondary v2-btn-sm">{{T $.Lang "v2.backups.edit"}}</a>
                        </div>
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
    {{else}}
    <div class="v2-card v2-empty">
        <svg class="v2-empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>
        <div style="font-size:0.875rem;margin-bottom:0.5rem;">{{T .Lang "v2.backups.cloud.empty"}}</div>
        <a href="/admin/rclone/add" class="v2-btn v2-btn-primary v2-btn-sm">+ {{T .Lang "v2.backups.add"}}</a>
    </div>
    {{end}}

    <!-- SSH Key section -->
    <div class="v2-card" style="margin-top:1rem;">
        <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.75rem;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="{{if .SSHKeyExists}}var(--success){{else}}var(--text-muted){{end}}" stroke-width="2"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>
            <span style="font-size:0.875rem;font-weight:600;color:var(--text-primary);">{{T .Lang "rclone.ssh_key.title"}}</span>
            {{if .SSHKeyExists}}<span class="v2-badge v2-badge-success">{{T .Lang "v2.backups.cloud.configured"}}</span>{{end}}
        </div>

        {{if .SSHKeyExists}}
        <!-- Key exists: show public key + regenerate -->
        <div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:0.75rem;">{{.SSHKeyRelPath}}</div>
        <div style="margin-bottom:0.75rem;">
            <label style="display:block;font-size:0.75rem;font-weight:500;color:var(--text-secondary);margin-bottom:0.25rem;">{{T .Lang "rclone.ssh_key.public_key"}}</label>
            <div style="display:flex;gap:0.5rem;">
                <textarea id="ssh-public-key" readonly rows="2" style="flex:1;padding:0.5rem;border:1px solid var(--border);border-radius:0.375rem;background:var(--bg-page);color:var(--text-primary);font-size:0.6875rem;font-family:monospace;resize:none;">{{.SSHKeyPublicKey}}</textarea>
                <button type="button" onclick="copyPublicKey()" class="v2-btn v2-btn-secondary v2-btn-sm" style="align-self:flex-start;">{{T .Lang "rclone.ssh_key.copy"}}</button>
            </div>
            <div style="font-size:0.6875rem;color:var(--text-muted);margin-top:0.25rem;">{{T .Lang "rclone.ssh_key.copy_hint"}}</div>
        </div>
        <button type="button" onclick="regenerateSSHKey()" class="v2-btn v2-btn-secondary v2-btn-sm">{{T .Lang "rclone.ssh_key.regenerate"}}</button>
        {{else}}
        <!-- No key: show generate button -->
        <p style="font-size:0.8125rem;color:var(--text-muted);margin-bottom:0.75rem;">{{T .Lang "rclone.ssh_key.none"}}</p>
        <button type="button" onclick="generateSSHKey()" class="v2-btn v2-btn-primary v2-btn-sm">{{T .Lang "rclone.ssh_key.generate"}}</button>
        {{end}}
    </div>

    <script>
    function copyPublicKey() {
        const textarea = document.getElementById('ssh-public-key');
        textarea.select();
        document.execCommand('copy');
        alert('{{T .Lang "rclone.ssh_key.copied"}}');
    }
    function generateSSHKey() {
        if (!confirm('{{T .Lang "rclone.ssh_key.generate_confirm"}}')) return;
        fetch('/admin/rclone/generate-key', { method: 'POST' })
            .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
            .then(data => { if (data.exists) location.reload(); else alert(data.error || 'Error'); })
            .catch(err => alert('Error: ' + err));
    }
    function regenerateSSHKey() {
        if (!confirm('{{T .Lang "rclone.ssh_key.regenerate_confirm"}}')) return;
        fetch('/admin/rclone/generate-key', { method: 'POST' })
            .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
            .then(data => { if (data.exists) location.reload(); else alert(data.error || 'Error'); })
            .catch(err => alert('Error: ' + err));
    }
    </script>
</div>

<!-- ===== P2P Sync Tab ===== -->
<div class="v2-tab-panel{{if eq .ActiveTab "p2p"}} active{{end}}" id="tab-p2p">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
        <div style="font-size:0.9375rem;font-weight:700;color:var(--text-primary);">{{T .Lang "v2.backups.p2p.title"}}</div>
        <div style="display:flex;gap:0.5rem;">
            <a href="/admin/peers" class="v2-btn v2-btn-secondary v2-btn-sm">{{T .Lang "v2.backups.p2p.configure"}}</a>
            <form method="POST" action="/admin/sync/force" style="display:inline;">
                <button type="submit" class="v2-btn v2-btn-primary v2-btn-sm">{{T .Lang "v2.backups.p2p.force_sync"}}</button>
            </form>
        </div>
    </div>

    <!-- Sync config status -->
    <div class="v2-card" style="margin-bottom:1rem;">
        <div style="display:flex;align-items:center;gap:1.5rem;flex-wrap:wrap;">
            <div>
                <div style="font-size:0.75rem;color:var(--text-muted);">{{T .Lang "v2.backups.p2p.status_label"}}</div>
                <div style="font-size:0.875rem;font-weight:600;">
                    {{if .SyncEnabled}}
                        <span style="color:var(--success);">{{T .Lang "v2.backups.p2p.enabled"}}</span>
                    {{else}}
                        <span style="color:var(--text-muted);">{{T .Lang "v2.backups.p2p.disabled"}}</span>
                    {{end}}
                </div>
            </div>
            {{if .SyncInterval}}
            <div>
                <div style="font-size:0.75rem;color:var(--text-muted);">{{T .Lang "v2.backups.p2p.interval"}}</div>
                <div style="font-size:0.875rem;font-weight:600;color:var(--text-primary);">{{.SyncInterval}}</div>
            </div>
            {{end}}
        </div>
    </div>

    <!-- Recent syncs -->
    {{if .RecentSyncs}}
    <div class="v2-card" style="padding:0;overflow:hidden;">
        <table class="v2-table">
            <thead>
                <tr>
                    <th>{{T .Lang "v2.backups.p2p.peer"}}</th>
                    <th>{{T .Lang "v2.backups.p2p.user"}}</th>
                    <th>{{T .Lang "v2.backups.usb.status"}}</th>
                    <th>{{T .Lang "v2.backups.p2p.files"}}</th>
                    <th>{{T .Lang "v2.backups.p2p.size"}}</th>
                    <th>{{T .Lang "v2.backups.p2p.date"}}</th>
                </tr>
            </thead>
            <tbody>
                {{range .RecentSyncs}}
                <tr>
                    <td style="font-weight:600;">{{.PeerName}}</td>
                    <td>{{.Username}}</td>
                    <td>
                        {{if eq .Status "success"}}
                            <span class="v2-badge v2-badge-success">{{T $.Lang "v2.backups.status.success"}}</span>
                        {{else if eq .Status "error"}}
                            <span class="v2-badge v2-badge-error">{{T $.Lang "v2.backups.status.error"}}</span>
                        {{else}}
                            <span class="v2-badge v2-badge-warning">{{.Status}}</span>
                        {{end}}
                    </td>
                    <td>{{.FilesSynced}}</td>
                    <td>{{.BytesSynced}}</td>
                    <td style="font-size:0.8125rem;color:var(--text-secondary);">{{.CompletedAt}}</td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
    {{else}}
    <div class="v2-card v2-empty">
        <div style="font-size:0.875rem;">{{T .Lang "v2.backups.p2p.empty"}}</div>
    </div>
    {{end}}
</div>

<!-- ===== Incoming Tab ===== -->
<div class="v2-tab-panel{{if eq .ActiveTab "incoming"}} active{{end}}" id="tab-incoming">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
        <div style="font-size:0.9375rem;font-weight:700;color:var(--text-primary);">{{T .Lang "v2.backups.incoming.title"}}</div>
    </div>

    {{if .IncomingBackups}}
    <div class="v2-stats-grid" style="margin-bottom:1rem;">
        <div class="v2-card">
            <div class="v2-card-title">{{T .Lang "v2.backups.incoming.total_backups"}}</div>
            <div class="v2-card-value">{{.IncomingCount}}</div>
        </div>
        <div class="v2-card">
            <div class="v2-card-title">{{T .Lang "v2.backups.incoming.total_size"}}</div>
            <div class="v2-card-value">{{.IncomingSize}}</div>
        </div>
    </div>

    <div class="v2-card" style="padding:0;overflow:hidden;">
        <table class="v2-table">
            <thead>
                <tr>
                    <th>{{T .Lang "v2.backups.incoming.source"}}</th>
                    <th>{{T .Lang "v2.backups.incoming.user"}}</th>
                    <th>{{T .Lang "v2.backups.incoming.share"}}</th>
                    <th>{{T .Lang "v2.backups.incoming.files"}}</th>
                    <th>{{T .Lang "v2.backups.p2p.size"}}</th>
                    <th>{{T .Lang "v2.backups.actions"}}</th>
                </tr>
            </thead>
            <tbody>
                {{range .IncomingBackups}}
                <tr>
                    <td style="font-weight:600;">{{.SourceServer}}</td>
                    <td>{{.UserID}}</td>
                    <td>{{.ShareName}}</td>
                    <td>{{.FileCount}}</td>
                    <td>{{.TotalSizeFormatted}}</td>
                    <td>
                        <form method="POST" action="/admin/incoming/delete" onsubmit="return confirm('{{T $.Lang "v2.backups.confirm_delete"}}');">
                            <input type="hidden" name="path" value="{{.Path}}">
                            <button type="submit" class="v2-btn v2-btn-danger v2-btn-sm">{{T $.Lang "v2.backups.delete"}}</button>
                        </form>
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
    {{else}}
    <div class="v2-card v2-empty">
        <svg class="v2-empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        <div style="font-size:0.875rem;">{{T .Lang "v2.backups.incoming.empty"}}</div>
    </div>
    {{end}}
</div>

<!-- ===== Server Backup Tab ===== -->
<div class="v2-tab-panel{{if eq .ActiveTab "server"}} active{{end}}" id="tab-server">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
        <div style="font-size:0.9375rem;font-weight:700;color:var(--text-primary);">{{T .Lang "v2.backups.server.title"}}</div>
        <form method="POST" action="/admin/backup/create" style="display:inline;">
            <button type="submit" class="v2-btn v2-btn-primary v2-btn-sm">+ {{T .Lang "v2.backups.server.create"}}</button>
        </form>
    </div>

    {{if .ServerBackups}}
    <div class="v2-card" style="padding:0;overflow:hidden;">
        <table class="v2-table">
            <thead>
                <tr>
                    <th>{{T .Lang "v2.backups.server.filename"}}</th>
                    <th>{{T .Lang "v2.backups.p2p.size"}}</th>
                    <th>{{T .Lang "v2.backups.p2p.date"}}</th>
                    <th>{{T .Lang "v2.backups.actions"}}</th>
                </tr>
            </thead>
            <tbody>
                {{range .ServerBackups}}
                <tr>
                    <td style="font-weight:600;">{{.Name}}</td>
                    <td>{{.SizeFormatted}}</td>
                    <td style="font-size:0.8125rem;color:var(--text-secondary);">{{.Date}}</td>
                    <td>
                        <div style="display:flex;gap:0.5rem;">
                            <button onclick="openDownloadModal('{{.Name}}')" class="v2-btn v2-btn-secondary v2-btn-sm">{{T $.Lang "v2.backups.server.download"}}</button>
                            <button onclick="deleteServerBackup('{{.Name}}')" class="v2-btn v2-btn-danger v2-btn-sm">{{T $.Lang "v2.backups.delete"}}</button>
                        </div>
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
    {{else}}
    <div class="v2-card v2-empty">
        <svg class="v2-empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="2" width="20" height="8" rx="2"/><rect x="2" y="14" width="20" height="8" rx="2"/></svg>
        <div style="font-size:0.875rem;margin-bottom:0.5rem;">{{T .Lang "v2.backups.server.empty"}}</div>
        <form method="POST" action="/admin/backup/create" style="display:inline;">
            <button type="submit" class="v2-btn v2-btn-primary v2-btn-sm">+ {{T .Lang "v2.backups.server.create"}}</button>
        </form>
    </div>
    {{end}}
</div>

<!-- Download Modal -->
<div id="downloadModal" class="hidden" style="position:fixed;inset:0;z-index:50;display:flex;align-items:center;justify-content:center;">
    <div style="position:fixed;inset:0;background:rgba(0,0,0,0.5);" onclick="closeDownloadModal()"></div>
    <div class="v2-card" style="position:relative;width:100%;max-width:28rem;padding:1.5rem;z-index:51;">
        <h3 style="font-size:1rem;font-weight:700;color:var(--text-primary);margin-bottom:1rem;">{{T .Lang "backup.download.title"}}</h3>
        <form id="downloadForm" method="POST" action="/admin/backup/download">
            <input type="hidden" name="filename" id="downloadFilename">
            <div style="margin-bottom:0.75rem;">
                <label style="display:block;font-size:0.8125rem;font-weight:500;color:var(--text-secondary);margin-bottom:0.375rem;">
                    {{T .Lang "backup.download.password"}}
                </label>
                <input type="password" name="passphrase" id="dlPassphrase" required minlength="12"
                       style="width:100%;padding:0.5rem 0.75rem;border-radius:0.375rem;border:1px solid var(--border);background:var(--bg-page);color:var(--text-primary);font-size:0.8125rem;"
                       placeholder="{{T .Lang "backup.download.password_placeholder"}}">
                <p style="font-size:0.7rem;color:var(--text-muted);margin-top:0.25rem;">{{T .Lang "backup.download.password_help"}}</p>
            </div>
            <div style="margin-bottom:0.75rem;">
                <label style="display:block;font-size:0.8125rem;font-weight:500;color:var(--text-secondary);margin-bottom:0.375rem;">
                    {{T .Lang "backup.download.confirm"}}
                </label>
                <input type="password" name="passphrase_confirm" id="dlPassphraseConfirm" required minlength="12"
                       style="width:100%;padding:0.5rem 0.75rem;border-radius:0.375rem;border:1px solid var(--border);background:var(--bg-page);color:var(--text-primary);font-size:0.8125rem;"
                       placeholder="{{T .Lang "backup.download.confirm_placeholder"}}">
            </div>
            <div style="background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.2);border-radius:0.375rem;padding:0.75rem;margin-bottom:1rem;font-size:0.75rem;color:var(--warning);">
                {{T .Lang "backup.download.warning"}}
            </div>
            <div style="display:flex;justify-content:flex-end;gap:0.5rem;">
                <button type="button" onclick="closeDownloadModal()" class="v2-btn v2-btn-secondary">{{T .Lang "common.cancel"}}</button>
                <button type="submit" class="v2-btn v2-btn-primary">{{T .Lang "backup.action.download"}}</button>
            </div>
        </form>
    </div>
</div>

<!-- Scripts -->
<script>
// Server backup: download modal
function openDownloadModal(filename) {
    document.getElementById('downloadFilename').value = filename;
    document.getElementById('dlPassphrase').value = '';
    document.getElementById('dlPassphraseConfirm').value = '';
    document.getElementById('downloadModal').classList.remove('hidden');
}
function closeDownloadModal() {
    document.getElementById('downloadModal').classList.add('hidden');
}
document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeDownloadModal(); });

var dlForm = document.getElementById('downloadForm');
if (dlForm) {
    dlForm.addEventListener('submit', function(e) {
        var p = document.getElementById('dlPassphrase').value;
        var c = document.getElementById('dlPassphraseConfirm').value;
        if (p !== c) { e.preventDefault(); alert('{{T .Lang "backup.download.error_mismatch"}}'); return; }
        if (p.length < 12) { e.preventDefault(); alert('{{T .Lang "backup.download.error_length"}}'); return; }
    });
}

// Server backup: delete
function deleteServerBackup(filename) {
    if (!confirm('{{T .Lang "backup.delete.confirm"}}')) return;
    fetch('/admin/backup/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'filename=' + encodeURIComponent(filename)
    }).then(function(r) {
        if (r.ok) { alert('{{T .Lang "backup.delete.success"}}'); location.reload(); }
        else { r.text().then(function(t) { alert('{{T .Lang "backup.delete.error"}}' + ': ' + t); }); }
    }).catch(function(err) { alert('{{T .Lang "backup.delete.error"}}' + ': ' + err.message); });
}

// Tab switching
function switchTab(tab) {
    // Update URL
    var url = new URL(window.location);
    url.searchParams.set('tab', tab);
    window.history.replaceState({}, '', url);

    // Update tab buttons
    document.querySelectorAll('.v2-tab').forEach(function(t) {
        t.classList.toggle('active', t.getAttribute('data-tab') === tab);
    });

    // Update panels
    document.querySelectorAll('.v2-tab-panel').forEach(function(p) {
        p.classList.toggle('active', p.id === 'tab-' + tab);
    });
}

// Restore tab from URL on load
(function() {
    var params = new URLSearchParams(window.location.search);
    var tab = params.get('tab');
    if (tab && document.getElementById('tab-' + tab)) {
        switchTab(tab);
    }
})();
</script>
{{end}}
