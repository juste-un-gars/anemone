{{/* Anemone v2 - Storage Management page */}}
{{define "headerActions"}}
<button data-action="refresh" class="v2-btn v2-btn-secondary v2-btn-sm">
    <svg style="display:inline;width:14px;height:14px;vertical-align:middle;margin-right:4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
    {{T .Lang "common.refresh"}}
</button>
{{end}}

{{define "content"}}
<style>
.help-tooltip {
    position:relative;display:inline-flex;align-items:center;justify-content:center;
    width:16px;height:16px;background:var(--bg-page);border-radius:50%;
    font-size:10px;color:var(--text-muted);cursor:help;margin-left:4px;flex-shrink:0;
}
.help-tooltip:hover::after {
    content:attr(data-tip);position:absolute;bottom:100%;left:50%;transform:translateX(-50%);
    background:var(--text-primary);color:var(--bg-card);padding:8px 12px;border-radius:6px;
    font-size:12px;font-weight:normal;white-space:normal;width:280px;max-width:90vw;
    z-index:100;box-shadow:0 4px 6px rgba(0,0,0,0.2);line-height:1.4;margin-bottom:4px;
}
.help-tooltip:hover::before {
    content:'';position:absolute;bottom:100%;left:50%;transform:translateX(-50%);
    border:6px solid transparent;border-top-color:var(--text-primary);margin-bottom:-8px;z-index:100;
}
.smart-value-good { color: var(--success); }
.smart-value-warning { color: var(--warning); }
.smart-value-critical { color: var(--error); }
.smart-card { background:var(--bg-page);border-radius:8px;padding:12px;margin-bottom:0.75rem; }
.smart-card-title { font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:8px; }
.storage-progress { width:100%;height:8px;background:var(--bg-page);border-radius:4px;overflow:hidden;margin:0.5rem 0; }
.storage-progress-bar { height:100%;border-radius:4px;transition:width 0.3s; }
</style>

<!-- Tab navigation -->
<div class="v2-tabs" id="storageTabs">
    <button class="v2-tab active" data-tab="overview" data-action="showTab">{{T .Lang "storage.tab_overview"}}</button>
    <button class="v2-tab" data-tab="disks" data-action="showTab">{{T .Lang "storage.tab_disks"}}</button>
    <button class="v2-tab" data-tab="pools" data-action="showTab">{{T .Lang "storage.tab_pools"}}</button>
    {{if .ZFSAvailable}}
    <button class="v2-tab" data-tab="datasets" data-action="showTab">{{T .Lang "storage.tab_datasets"}}</button>
    <button class="v2-tab" data-tab="snapshots" data-action="showTab">{{T .Lang "storage.tab_snapshots"}}</button>
    {{end}}
</div>

<!-- ===== Overview Tab ===== -->
<div class="v2-tab-panel active" id="tab-overview">
    <div class="v2-stats-grid" style="margin-bottom:1.5rem;">
        <div class="v2-card">
            <div class="v2-card-title">{{T .Lang "storage.total_disks"}}</div>
            <div class="v2-card-value">{{.Overview.TotalDisks}}</div>
        </div>
        <div class="v2-card">
            <div class="v2-card-title">{{T .Lang "storage.disk_health"}}</div>
            <div class="v2-card-value">
                <span style="color:var(--success);">{{.Overview.HealthyDisks}}</span>
                {{if gt .Overview.WarningDisks 0}} / <span style="color:var(--warning);">{{.Overview.WarningDisks}}</span>{{end}}
                {{if gt .Overview.CriticalDisks 0}} / <span style="color:var(--error);">{{.Overview.CriticalDisks}}</span>{{end}}
            </div>
        </div>
        <div class="v2-card">
            <div class="v2-card-title">{{T .Lang "storage.zfs_pools"}}</div>
            <div class="v2-card-value">
                {{if .ZFSAvailable}}{{.Overview.TotalPools}}{{if gt .Overview.DegradedPools 0}} <span style="font-size:0.75rem;color:var(--warning);">({{.Overview.DegradedPools}} {{T .Lang "storage.degraded"}})</span>{{end}}
                {{else}}<span style="color:var(--text-muted);">{{T .Lang "storage.not_available"}}</span>{{end}}
            </div>
        </div>
        <div class="v2-card">
            <div class="v2-card-title">{{T .Lang "storage.total_capacity"}}</div>
            <div class="v2-card-value">
                {{if .Overview.TotalCapacity}}{{.Overview.UsedCapHuman}} / {{.Overview.TotalCapHuman}}{{else}}-{{end}}
            </div>
        </div>
    </div>
</div>

<!-- ===== Disks Tab ===== -->
<div class="v2-tab-panel" id="tab-disks">
    <div class="v2-card" style="margin-bottom:1rem;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
            <div>
                <div style="font-size:0.9375rem;font-weight:600;color:var(--text-primary);">{{T .Lang "storage.physical_disks"}}</div>
                <div style="font-size:0.75rem;color:var(--text-muted);margin-top:0.25rem;">{{if .SMARTAvailable}}{{T .Lang "storage.smart_enabled"}}{{else}}{{T .Lang "storage.smart_disabled"}}{{end}}</div>
            </div>
        </div>
        {{if .Disks}}
        <div style="overflow-x:auto;">
            <table class="v2-table">
                <thead>
                    <tr>
                        <th>{{T .Lang "storage.disk"}}</th>
                        <th>{{T .Lang "storage.model"}}</th>
                        <th>{{T .Lang "storage.size"}}</th>
                        <th>{{T .Lang "storage.type"}}</th>
                        <th>{{T .Lang "storage.status"}}</th>
                        <th>{{T .Lang "storage.health"}}</th>
                        <th>{{T .Lang "storage.temp"}}</th>
                        <th>{{T .Lang "storage.power_on"}}</th>
                        <th>{{T .Lang "users.actions"}}</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .Disks}}
                    <tr>
                        <td>
                            <div style="font-weight:500;color:var(--text-primary);">{{.Name}}</div>
                            <div style="font-size:0.6875rem;color:var(--text-muted);">{{.Path}}</div>
                        </td>
                        <td>{{if .Model}}{{.Model}}{{else}}-{{end}}</td>
                        <td>{{.SizeHuman}}</td>
                        <td>
                            <span class="v2-badge {{if eq .Type "NVMe"}}v2-badge-info{{else if eq .Type "SSD"}}v2-badge-info{{end}}">{{.Type}}</span>
                        </td>
                        <td>
                            {{if .Mountpoint}}
                            <div style="display:flex;align-items:center;gap:0.25rem;">
                                <svg style="width:14px;height:14px;color:var(--success);" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                                <span style="font-family:monospace;font-size:0.6875rem;color:var(--success);">{{.Mountpoint}}</span>
                                {{if .Filesystem}}<span style="font-size:0.6875rem;color:var(--text-muted);margin-left:0.25rem;">({{.Filesystem}})</span>{{end}}
                            </div>
                            {{else if .Filesystem}}
                            <div style="display:flex;align-items:center;gap:0.25rem;">
                                <span class="v2-badge v2-badge-warning">{{.Filesystem}}</span>
                                <span style="font-size:0.6875rem;color:var(--text-muted);">{{T $.Lang "storage.not_mounted"}}</span>
                            </div>
                            {{else}}<span style="color:var(--text-muted);">-</span>{{end}}
                        </td>
                        <td>
                            <span class="v2-badge {{if eq .Health "OK"}}v2-badge-success{{else if eq .Health "WARNING"}}v2-badge-warning{{else if eq .Health "CRITICAL"}}v2-badge-error{{end}}">{{.Health}}</span>
                        </td>
                        <td>
                            {{if ge .Temperature 0}}<span style="{{if gt .Temperature 55}}color:var(--error);{{else if gt .Temperature 45}}color:var(--warning);{{end}}">{{.Temperature}}Â°C</span>{{else}}-{{end}}
                        </td>
                        <td>{{if ge .PowerOnHours 0}}{{.PowerOnHours}}h{{else}}-{{end}}</td>
                        <td>
                            <div style="display:flex;gap:0.5rem;align-items:center;">
                                <button data-action="showSMARTDetails" data-disk="{{.Name}}" class="v2-btn v2-btn-secondary v2-btn-sm">SMART</button>
                                {{if .Mountpoint}}
                                <button data-action="unmountDisk" data-mountpoint="{{.Mountpoint}}" class="v2-btn v2-btn-secondary v2-btn-sm" title="{{T $.Lang "storage.unmount"}}">
                                    <svg style="display:inline;width:14px;height:14px;vertical-align:middle;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                                </button>
                                <button data-action="ejectDisk" data-mountpoint="{{.Mountpoint}}" class="v2-btn v2-btn-secondary v2-btn-sm" title="{{T $.Lang "storage.eject"}}">
                                    <svg style="display:inline;width:14px;height:14px;vertical-align:middle;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/></svg>
                                </button>
                                {{else if .Filesystem}}
                                <button data-action="showMountDiskModal" data-path="{{.Path}}" data-disk="{{.Name}}" class="v2-btn v2-btn-secondary v2-btn-sm">{{T $.Lang "storage.mount"}}</button>
                                <button data-action="showFormatDiskModal" data-path="{{.Path}}" class="v2-btn v2-btn-danger v2-btn-sm">{{T $.Lang "storage.format"}}</button>
                                {{else}}
                                <button data-action="showFormatDiskModal" data-path="{{.Path}}" class="v2-btn v2-btn-danger v2-btn-sm">{{T $.Lang "storage.format"}}</button>
                                {{end}}
                            </div>
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
        {{else}}
        <div class="v2-empty">
            <div class="v2-empty-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/></svg>
            </div>
            <div>{{T .Lang "storage.no_disks"}}</div>
        </div>
        {{end}}
    </div>
</div>

<!-- ===== Pools Tab ===== -->
<div class="v2-tab-panel" id="tab-pools">
    {{if .ZFSAvailable}}
    <div style="display:flex;justify-content:flex-end;gap:0.5rem;margin-bottom:1rem;">
        <button data-action="showImportPoolModal" class="v2-btn v2-btn-secondary v2-btn-sm">{{T .Lang "storage.import_pool"}}</button>
        <button data-action="showCreatePoolModal" class="v2-btn v2-btn-primary v2-btn-sm">{{T .Lang "storage.create_pool"}}</button>
    </div>
    {{if .Pools}}
    {{range .Pools}}
    <div class="v2-card" style="margin-bottom:1rem;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem;flex-wrap:wrap;gap:0.5rem;">
            <div style="display:flex;align-items:center;gap:0.5rem;">
                <span style="font-size:1rem;font-weight:600;color:var(--text-primary);">{{.Name}}</span>
                <span class="v2-badge {{if eq .State "ONLINE"}}v2-badge-success{{else if eq .State "DEGRADED"}}v2-badge-warning{{else}}v2-badge-error{{end}}">{{.State}}</span>
            </div>
            <div style="display:flex;gap:0.375rem;">
                <button data-action="startScrub" data-pool="{{.Name}}" class="v2-btn v2-btn-secondary v2-btn-sm">{{T $.Lang "storage.start_scrub"}}</button>
                <button data-action="showExportPoolModal" data-pool="{{.Name}}" class="v2-btn v2-btn-secondary v2-btn-sm">{{T $.Lang "storage.export"}}</button>
                <button data-action="showDestroyPoolModal" data-pool="{{.Name}}" class="v2-btn v2-btn-danger v2-btn-sm">{{T $.Lang "storage.destroy"}}</button>
            </div>
        </div>
        <!-- Progress bar -->
        <div class="storage-progress">
            <div class="storage-progress-bar" style="width:{{printf "%.1f" .UsedPercent}}%;background:{{if gt .UsedPercent 90.0}}var(--error){{else if gt .UsedPercent 80.0}}var(--warning){{else}}var(--success){{end}};"></div>
        </div>
        <div style="font-size:0.8125rem;color:var(--text-secondary);margin-bottom:0.75rem;">{{.AllocHuman}} / {{.SizeHuman}} ({{printf "%.1f" .UsedPercent}}%)</div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:0.5rem;font-size:0.8125rem;margin-bottom:0.75rem;">
            <div><span style="color:var(--text-muted);">{{T $.Lang "storage.free"}}:</span> <span style="color:var(--text-primary);">{{.FreeHuman}}</span></div>
            <div><span style="color:var(--text-muted);">{{T $.Lang "storage.fragmentation"}}:</span> <span style="color:var(--text-primary);">{{.Fragmentation}}%</span></div>
            <div><span style="color:var(--text-muted);">{{T $.Lang "storage.dedup"}}:</span> <span style="color:var(--text-primary);">{{printf "%.2f" .Dedup}}x</span></div>
            <div><span style="color:var(--text-muted);">{{T $.Lang "storage.errors"}}:</span> <span style="{{if ne .Errors "No known data errors"}}color:var(--error);{{else}}color:var(--text-primary);{{end}}">{{.Errors}}</span></div>
        </div>
        <div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:0.75rem;"><span style="font-weight:500;">{{T $.Lang "storage.scan"}}:</span> {{.ScanStatus}}</div>
        {{if .VDevs}}
        <div style="margin-top:0.5rem;">
            <div style="font-size:0.8125rem;font-weight:500;color:var(--text-secondary);margin-bottom:0.5rem;">{{T $.Lang "storage.vdevs"}}</div>
            {{range .VDevs}}
            <div style="background:var(--bg-page);border-radius:6px;padding:0.75rem;margin-bottom:0.5rem;">
                <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem;">
                    <span style="font-weight:500;color:var(--text-primary);">{{.Name}}</span>
                    <span class="v2-badge">{{.Type}}</span>
                    <span class="v2-badge {{if eq .State "ONLINE"}}v2-badge-success{{else if eq .State "DEGRADED"}}v2-badge-warning{{else}}v2-badge-error{{end}}">{{.State}}</span>
                </div>
                {{if .Disks}}
                <div style="margin-left:1rem;">
                    {{range .Disks}}
                    <div style="display:flex;align-items:center;gap:0.5rem;font-size:0.8125rem;padding:0.125rem 0;">
                        <span style="color:var(--text-secondary);">{{.Name}}</span>
                        <span class="v2-badge {{if eq .State "ONLINE"}}v2-badge-success{{else if eq .State "DEGRADED"}}v2-badge-warning{{else}}v2-badge-error{{end}}" style="font-size:0.625rem;">{{.State}}</span>
                        {{if or (gt .Read 0) (gt .Write 0) (gt .Cksum 0)}}<span style="font-size:0.6875rem;color:var(--error);">R:{{.Read}} W:{{.Write}} C:{{.Cksum}}</span>{{end}}
                    </div>
                    {{end}}
                </div>
                {{end}}
            </div>
            {{end}}
        </div>
        {{end}}
    </div>
    {{end}}
    {{else}}
    <div class="v2-card">
        <div class="v2-empty">
            <div class="v2-empty-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
            </div>
            <div>{{T .Lang "storage.no_pools"}}</div>
            <div style="font-size:0.75rem;color:var(--text-muted);">{{T .Lang "storage.no_pools_info"}}</div>
        </div>
    </div>
    {{end}}
    {{else}}
    <div class="v2-card" style="border-left:3px solid var(--warning);">
        <div style="font-size:0.875rem;color:var(--text-secondary);">{{T .Lang "storage.zfs_not_installed"}}</div>
        <div style="font-size:0.75rem;color:var(--text-muted);margin-top:0.25rem;">{{T .Lang "storage.zfs_install_info"}}</div>
    </div>
    {{end}}
</div>

{{if .ZFSAvailable}}
<!-- ===== Datasets Tab ===== -->
<div class="v2-tab-panel" id="tab-datasets">
    <div style="display:flex;justify-content:flex-end;margin-bottom:1rem;">
        <button data-action="showCreateDatasetModal" class="v2-btn v2-btn-primary v2-btn-sm">{{T .Lang "storage.create_dataset"}}</button>
    </div>
    <div class="v2-card">
        <div id="datasets-list">
            <div style="text-align:center;color:var(--text-muted);padding:2rem;">{{T .Lang "common.loading"}}...</div>
        </div>
    </div>
</div>

<!-- ===== Snapshots Tab ===== -->
<div class="v2-tab-panel" id="tab-snapshots">
    <div style="display:flex;justify-content:flex-end;margin-bottom:1rem;">
        <button data-action="showCreateSnapshotModal" class="v2-btn v2-btn-primary v2-btn-sm">{{T .Lang "storage.create_snapshot"}}</button>
    </div>
    <div class="v2-card">
        <div id="snapshots-list">
            <div style="text-align:center;color:var(--text-muted);padding:2rem;">{{T .Lang "common.loading"}}...</div>
        </div>
    </div>
</div>
{{end}}

<!-- Password Verification Modal -->
<div id="passwordModal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;">
    <div class="v2-card" style="width:24rem;max-width:90vw;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
            <div id="passwordModalTitle" style="font-size:0.9375rem;font-weight:600;color:var(--text-primary);">{{T .Lang "storage.confirm_action"}}</div>
            <button data-action="closePasswordModal" style="background:none;border:none;cursor:pointer;color:var(--text-muted);font-size:1.25rem;">&times;</button>
        </div>
        <div id="passwordModalWarning" style="background:rgba(239,68,68,0.1);border:1px solid var(--error);border-radius:6px;padding:0.75rem;margin-bottom:1rem;font-size:0.8125rem;color:var(--error);"></div>
        <form id="passwordForm">
            <div style="margin-bottom:1rem;">
                <label style="display:block;font-size:0.8125rem;font-weight:500;color:var(--text-secondary);margin-bottom:0.25rem;">{{T .Lang "settings.password.current"}}</label>
                <input type="password" id="verifyPassword" required style="width:100%;padding:0.5rem 0.75rem;border:1px solid var(--border);border-radius:6px;background:var(--bg-page);color:var(--text-primary);font-size:0.875rem;">
            </div>
            <div style="display:flex;justify-content:flex-end;gap:0.5rem;">
                <button type="button" data-action="closePasswordModal" class="v2-btn v2-btn-secondary">{{T .Lang "common.cancel"}}</button>
                <button type="submit" class="v2-btn v2-btn-danger">{{T .Lang "storage.confirm"}}</button>
            </div>
        </form>
    </div>
</div>

<!-- SMART Details Modal -->
<div id="smartModal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;">
    <div class="v2-card" style="width:48rem;max-width:90vw;max-height:85vh;overflow-y:auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;position:sticky;top:0;background:var(--bg-card);padding-bottom:0.5rem;border-bottom:1px solid var(--border);">
            <div style="font-size:0.9375rem;font-weight:600;color:var(--text-primary);">{{T .Lang "storage.smart_details"}} - <span id="smartDiskName"></span></div>
            <button data-action="closeSMARTModal" style="background:none;border:none;cursor:pointer;color:var(--text-muted);font-size:1.25rem;">&times;</button>
        </div>
        <div id="smartContent"></div>
    </div>
</div>

<!-- Create Pool Modal -->
<div id="createPoolModal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;">
    <div class="v2-card" style="width:30rem;max-width:90vw;max-height:85vh;overflow-y:auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
            <div style="font-size:0.9375rem;font-weight:600;color:var(--text-primary);">{{T .Lang "storage.create_pool"}}</div>
            <button data-action="closeCreatePoolModal" style="background:none;border:none;cursor:pointer;color:var(--text-muted);font-size:1.25rem;">&times;</button>
        </div>
        <form id="createPoolForm">
            <div style="display:flex;flex-direction:column;gap:1rem;">
                <div>
                    <label style="display:block;font-size:0.8125rem;font-weight:500;color:var(--text-secondary);margin-bottom:0.25rem;">{{T .Lang "storage.pool_name"}}</label>
                    <input type="text" id="poolName" required pattern="[a-zA-Z][a-zA-Z0-9_\-.:]*" style="width:100%;padding:0.5rem 0.75rem;border:1px solid var(--border);border-radius:6px;background:var(--bg-page);color:var(--text-primary);font-size:0.875rem;">
                </div>
                <div>
                    <label style="display:block;font-size:0.8125rem;font-weight:500;color:var(--text-secondary);margin-bottom:0.25rem;">{{T .Lang "storage.vdev_type"}}</label>
                    <select id="poolVdevType" style="width:100%;padding:0.5rem 0.75rem;border:1px solid var(--border);border-radius:6px;background:var(--bg-page);color:var(--text-primary);font-size:0.875rem;">
                        <option value="stripe">Stripe ({{T .Lang "storage.no_redundancy"}})</option>
                        <option value="mirror">Mirror ({{T .Lang "storage.mirror_desc"}})</option>
                        <option value="raidz1">RAIDZ1 ({{T .Lang "storage.raidz1_desc"}})</option>
                        <option value="raidz2">RAIDZ2 ({{T .Lang "storage.raidz2_desc"}})</option>
                        <option value="raidz3">RAIDZ3 ({{T .Lang "storage.raidz3_desc"}})</option>
                    </select>
                </div>
                <div>
                    <label style="display:block;font-size:0.8125rem;font-weight:500;color:var(--text-secondary);margin-bottom:0.25rem;">{{T .Lang "storage.select_disks"}}</label>
                    <div id="poolDisksList" style="max-height:12rem;overflow-y:auto;border:1px solid var(--border);border-radius:6px;padding:0.5rem;background:var(--bg-page);"></div>
                </div>
                <div>
                    <label style="display:block;font-size:0.8125rem;font-weight:500;color:var(--text-secondary);margin-bottom:0.25rem;">{{T .Lang "storage.mountpoint"}}</label>
                    <input type="text" id="poolMountpoint" placeholder="/mnt/pool" pattern="^/[a-zA-Z0-9/_\-]*$" style="width:100%;padding:0.5rem 0.75rem;border:1px solid var(--border);border-radius:6px;background:var(--bg-page);color:var(--text-primary);font-size:0.875rem;">
                    <div style="font-size:0.6875rem;color:var(--text-muted);margin-top:0.25rem;">{{T .Lang "storage.mountpoint_help"}}</div>
                </div>
                <div>
                    <label style="display:block;font-size:0.8125rem;font-weight:500;color:var(--text-secondary);margin-bottom:0.25rem;">{{T .Lang "storage.compression"}}</label>
                    <select id="poolCompression" style="width:100%;padding:0.5rem 0.75rem;border:1px solid var(--border);border-radius:6px;background:var(--bg-page);color:var(--text-primary);font-size:0.875rem;">
                        <option value="lz4">LZ4 ({{T .Lang "storage.recommended"}})</option>
                        <option value="zstd">ZSTD</option>
                        <option value="off">{{T .Lang "storage.off"}}</option>
                    </select>
                </div>
            </div>
            <div style="display:flex;justify-content:flex-end;gap:0.5rem;margin-top:1.5rem;">
                <button type="button" data-action="closeCreatePoolModal" class="v2-btn v2-btn-secondary">{{T .Lang "common.cancel"}}</button>
                <button type="submit" class="v2-btn v2-btn-primary">{{T .Lang "storage.create"}}</button>
            </div>
        </form>
    </div>
</div>

<!-- Create Dataset Modal -->
<div id="createDatasetModal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;">
    <div class="v2-card" style="width:24rem;max-width:90vw;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
            <div style="font-size:0.9375rem;font-weight:600;color:var(--text-primary);">{{T .Lang "storage.create_dataset"}}</div>
            <button data-action="closeCreateDatasetModal" style="background:none;border:none;cursor:pointer;color:var(--text-muted);font-size:1.25rem;">&times;</button>
        </div>
        <form id="createDatasetForm">
            <div style="display:flex;flex-direction:column;gap:1rem;">
                <div>
                    <label style="display:block;font-size:0.8125rem;font-weight:500;color:var(--text-secondary);margin-bottom:0.25rem;">{{T .Lang "storage.dataset_name"}}</label>
                    <input type="text" id="datasetName" required placeholder="pool/dataset" style="width:100%;padding:0.5rem 0.75rem;border:1px solid var(--border);border-radius:6px;background:var(--bg-page);color:var(--text-primary);font-size:0.875rem;">
                    <div style="font-size:0.6875rem;color:var(--text-muted);margin-top:0.25rem;">{{T .Lang "storage.dataset_name_help"}}</div>
                </div>
                <div>
                    <label style="display:block;font-size:0.8125rem;font-weight:500;color:var(--text-secondary);margin-bottom:0.25rem;">{{T .Lang "storage.compression"}}</label>
                    <select id="datasetCompression" style="width:100%;padding:0.5rem 0.75rem;border:1px solid var(--border);border-radius:6px;background:var(--bg-page);color:var(--text-primary);font-size:0.875rem;">
                        <option value="">{{T .Lang "storage.inherit"}}</option>
                        <option value="lz4">LZ4</option>
                        <option value="zstd">ZSTD</option>
                        <option value="off">{{T .Lang "storage.off"}}</option>
                    </select>
                </div>
                <div>
                    <label style="display:block;font-size:0.8125rem;font-weight:500;color:var(--text-secondary);margin-bottom:0.25rem;">{{T .Lang "storage.quota"}}</label>
                    <input type="text" id="datasetQuota" placeholder="10G" style="width:100%;padding:0.5rem 0.75rem;border:1px solid var(--border);border-radius:6px;background:var(--bg-page);color:var(--text-primary);font-size:0.875rem;">
                    <div style="font-size:0.6875rem;color:var(--text-muted);margin-top:0.25rem;">{{T .Lang "storage.quota_help"}}</div>
                </div>
            </div>
            <div style="display:flex;justify-content:flex-end;gap:0.5rem;margin-top:1.5rem;">
                <button type="button" data-action="closeCreateDatasetModal" class="v2-btn v2-btn-secondary">{{T .Lang "common.cancel"}}</button>
                <button type="submit" class="v2-btn v2-btn-primary">{{T .Lang "storage.create"}}</button>
            </div>
        </form>
    </div>
</div>

<!-- Create Snapshot Modal -->
<div id="createSnapshotModal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;">
    <div class="v2-card" style="width:24rem;max-width:90vw;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
            <div style="font-size:0.9375rem;font-weight:600;color:var(--text-primary);">{{T .Lang "storage.create_snapshot"}}</div>
            <button data-action="closeCreateSnapshotModal" style="background:none;border:none;cursor:pointer;color:var(--text-muted);font-size:1.25rem;">&times;</button>
        </div>
        <form id="createSnapshotForm">
            <div style="display:flex;flex-direction:column;gap:1rem;">
                <div>
                    <label style="display:block;font-size:0.8125rem;font-weight:500;color:var(--text-secondary);margin-bottom:0.25rem;">{{T .Lang "storage.dataset"}}</label>
                    <select id="snapshotDataset" required style="width:100%;padding:0.5rem 0.75rem;border:1px solid var(--border);border-radius:6px;background:var(--bg-page);color:var(--text-primary);font-size:0.875rem;"></select>
                </div>
                <div>
                    <label style="display:block;font-size:0.8125rem;font-weight:500;color:var(--text-secondary);margin-bottom:0.25rem;">{{T .Lang "storage.snapshot_name"}}</label>
                    <input type="text" id="snapshotName" required pattern="[a-zA-Z0-9][a-zA-Z0-9_\-.:]*" style="width:100%;padding:0.5rem 0.75rem;border:1px solid var(--border);border-radius:6px;background:var(--bg-page);color:var(--text-primary);font-size:0.875rem;">
                    <div style="font-size:0.6875rem;color:var(--text-muted);margin-top:0.25rem;">{{T .Lang "storage.snapshot_name_help"}}</div>
                </div>
            </div>
            <div style="display:flex;justify-content:flex-end;gap:0.5rem;margin-top:1.5rem;">
                <button type="button" data-action="closeCreateSnapshotModal" class="v2-btn v2-btn-secondary">{{T .Lang "common.cancel"}}</button>
                <button type="submit" class="v2-btn v2-btn-primary">{{T .Lang "storage.create"}}</button>
            </div>
        </form>
    </div>
</div>

<!-- Format Disk Modal -->
<div id="formatDiskModal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;">
    <div class="v2-card" style="width:24rem;max-width:90vw;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
            <div style="font-size:0.9375rem;font-weight:600;color:var(--text-primary);">{{T .Lang "storage.format_disk"}}</div>
            <button data-action="closeFormatDiskModal" style="background:none;border:none;cursor:pointer;color:var(--text-muted);font-size:1.25rem;">&times;</button>
        </div>
        <div style="background:rgba(239,68,68,0.1);border:1px solid var(--error);border-radius:6px;padding:0.75rem;margin-bottom:1rem;font-size:0.8125rem;color:var(--error);">{{T .Lang "storage.format_warning"}}</div>
        <form id="formatDiskForm">
            <input type="hidden" id="formatDiskDevice">
            <div style="display:flex;flex-direction:column;gap:1rem;">
                <div>
                    <label style="display:block;font-size:0.8125rem;font-weight:500;color:var(--text-secondary);margin-bottom:0.25rem;">{{T .Lang "storage.device"}}</label>
                    <div id="formatDiskDeviceDisplay" style="font-family:monospace;font-size:0.8125rem;background:var(--bg-page);padding:0.5rem 0.75rem;border-radius:6px;color:var(--text-primary);"></div>
                </div>
                <div>
                    <label style="display:block;font-size:0.8125rem;font-weight:500;color:var(--text-secondary);margin-bottom:0.25rem;">{{T .Lang "storage.filesystem"}}</label>
                    <select id="formatFilesystem" style="width:100%;padding:0.5rem 0.75rem;border:1px solid var(--border);border-radius:6px;background:var(--bg-page);color:var(--text-primary);font-size:0.875rem;">
                        <option value="ext4">ext4 (Linux)</option>
                        <option value="xfs">XFS (Linux)</option>
                        <option value="exfat">exFAT (Windows/Mac/Linux)</option>
                        <option value="fat32">FAT32 ({{T .Lang "usb_format.universal"}})</option>
                    </select>
                </div>
                <div>
                    <label style="display:block;font-size:0.8125rem;font-weight:500;color:var(--text-secondary);margin-bottom:0.25rem;">{{T .Lang "storage.label"}}</label>
                    <input type="text" id="formatLabel" maxlength="12" style="width:100%;padding:0.5rem 0.75rem;border:1px solid var(--border);border-radius:6px;background:var(--bg-page);color:var(--text-primary);font-size:0.875rem;">
                </div>
                <div style="border-top:1px solid var(--border);padding-top:1rem;">
                    <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;">
                        <input type="checkbox" id="formatMount" checked>
                        <span style="font-size:0.8125rem;color:var(--text-secondary);">{{T .Lang "storage.mount_after_format"}}</span>
                    </label>
                    <div id="mountPathContainer" style="margin-top:0.5rem;">
                        <input type="text" id="formatMountPath" placeholder="/mnt/sda" style="width:100%;padding:0.5rem 0.75rem;border:1px solid var(--border);border-radius:6px;background:var(--bg-page);color:var(--text-primary);font-size:0.8125rem;font-family:monospace;">
                    </div>
                    <div id="formatSharedAccessContainer" style="margin-top:0.5rem;">
                        <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;">
                            <input type="checkbox" id="formatSharedAccess" checked>
                            <span style="font-size:0.8125rem;color:var(--text-secondary);">{{T .Lang "storage.shared_access"}}</span>
                        </label>
                        <div style="font-size:0.6875rem;color:var(--text-muted);margin-left:1.5rem;">{{T .Lang "storage.shared_access_hint"}}</div>
                    </div>
                    <div id="formatPersistentContainer" style="margin-top:0.5rem;">
                        <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;">
                            <input type="checkbox" id="formatPersistent" checked>
                            <span style="font-size:0.8125rem;color:var(--text-secondary);">{{T .Lang "storage.persistent_mount"}}</span>
                        </label>
                        <div style="font-size:0.6875rem;color:var(--text-muted);margin-left:1.5rem;">{{T .Lang "storage.persistent_mount_hint"}}</div>
                    </div>
                </div>
            </div>
            <div style="display:flex;justify-content:flex-end;gap:0.5rem;margin-top:1.5rem;">
                <button type="button" data-action="closeFormatDiskModal" class="v2-btn v2-btn-secondary">{{T .Lang "common.cancel"}}</button>
                <button type="submit" class="v2-btn v2-btn-danger">{{T .Lang "storage.format"}}</button>
            </div>
        </form>
    </div>
</div>

<!-- Mount Disk Modal -->
<div id="mountDiskModal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;">
    <div class="v2-card" style="width:24rem;max-width:90vw;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
            <div style="font-size:0.9375rem;font-weight:600;color:var(--text-primary);">{{T .Lang "storage.mount_disk"}}</div>
            <button data-action="closeMountDiskModal" style="background:none;border:none;cursor:pointer;color:var(--text-muted);font-size:1.25rem;">&times;</button>
        </div>
        <form id="mountDiskForm">
            <input type="hidden" id="mountDiskDevice">
            <div style="display:flex;flex-direction:column;gap:1rem;">
                <div>
                    <label style="display:block;font-size:0.8125rem;font-weight:500;color:var(--text-secondary);margin-bottom:0.25rem;">{{T .Lang "storage.device"}}</label>
                    <div id="mountDiskDeviceDisplay" style="font-family:monospace;font-size:0.8125rem;background:var(--bg-page);padding:0.5rem 0.75rem;border-radius:6px;color:var(--text-primary);"></div>
                </div>
                <div>
                    <label style="display:block;font-size:0.8125rem;font-weight:500;color:var(--text-secondary);margin-bottom:0.25rem;">{{T .Lang "storage.mount_path"}}</label>
                    <input type="text" id="mountDiskPath" required placeholder="/mnt/sda" style="width:100%;padding:0.5rem 0.75rem;border:1px solid var(--border);border-radius:6px;background:var(--bg-page);color:var(--text-primary);font-size:0.8125rem;font-family:monospace;">
                    <div style="font-size:0.6875rem;color:var(--text-muted);margin-top:0.25rem;">{{T .Lang "storage.mount_path_hint"}}</div>
                </div>
                <div style="border-top:1px solid var(--border);padding-top:1rem;">
                    <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;">
                        <input type="checkbox" id="mountSharedAccess" checked>
                        <span style="font-size:0.8125rem;color:var(--text-secondary);">{{T .Lang "storage.shared_access"}}</span>
                    </label>
                    <div style="font-size:0.6875rem;color:var(--text-muted);margin-left:1.5rem;">{{T .Lang "storage.shared_access_hint"}}</div>
                    <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;margin-top:0.5rem;">
                        <input type="checkbox" id="mountPersistent">
                        <span style="font-size:0.8125rem;color:var(--text-secondary);">{{T .Lang "storage.persistent_mount"}}</span>
                    </label>
                    <div style="font-size:0.6875rem;color:var(--text-muted);margin-left:1.5rem;">{{T .Lang "storage.persistent_mount_hint"}}</div>
                </div>
            </div>
            <div style="display:flex;justify-content:flex-end;gap:0.5rem;margin-top:1.5rem;">
                <button type="button" data-action="closeMountDiskModal" class="v2-btn v2-btn-secondary">{{T .Lang "common.cancel"}}</button>
                <button type="submit" class="v2-btn v2-btn-primary">{{T .Lang "storage.mount"}}</button>
            </div>
        </form>
    </div>
</div>

{{end}}

{{define "pageScripts"}}
<script type="application/json" id="page-data">
{
    "poolNames": "{{range .Pools}}{{.Name}},{{end}}",
    "translations": {
        "loading": "{{T .Lang "common.loading"}}",
        "error": "{{T .Lang "common.error"}}",
        "deleteBtn": "{{T .Lang "common.delete"}}",
        "loginError": "{{T .Lang "login.error"}}",
        "confirmScrub": "{{T .Lang "storage.confirm_scrub"}}",
        "scrubStarted": "{{T .Lang "storage.scrub_started"}}",
        "scrubError": "{{T .Lang "storage.scrub_error"}}",
        "createPool": "{{T .Lang "storage.create_pool"}}",
        "createPoolWarning": "{{T .Lang "storage.create_pool_warning"}}",
        "poolCreated": "{{T .Lang "storage.pool_created"}}",
        "destroyPool": "{{T .Lang "storage.destroy_pool"}}",
        "destroyPoolWarning": "{{T .Lang "storage.destroy_pool_warning"}}",
        "poolDestroyed": "{{T .Lang "storage.pool_destroyed"}}",
        "exportPool": "{{T .Lang "storage.export_pool"}}",
        "exportPoolWarning": "{{T .Lang "storage.export_pool_warning"}}",
        "poolExported": "{{T .Lang "storage.pool_exported"}}",
        "importPool": "{{T .Lang "storage.import_pool"}}",
        "importPoolWarning": "{{T .Lang "storage.import_pool_warning"}}",
        "poolImported": "{{T .Lang "storage.pool_imported"}}",
        "noImportablePools": "{{T .Lang "storage.no_importable_pools"}}",
        "selectPoolToImport": "{{T .Lang "storage.select_pool_to_import"}}",
        "noPools": "{{T .Lang "storage.no_pools"}}",
        "noDatasets": "{{T .Lang "storage.no_datasets"}}",
        "noSnapshots": "{{T .Lang "storage.no_snapshots"}}",
        "createDataset": "{{T .Lang "storage.create_dataset"}}",
        "createDatasetWarning": "{{T .Lang "storage.create_dataset_warning"}}",
        "datasetCreated": "{{T .Lang "storage.dataset_created"}}",
        "deleteDataset": "{{T .Lang "storage.delete_dataset"}}",
        "deleteDatasetWarning": "{{T .Lang "storage.delete_dataset_warning"}}",
        "datasetDeleted": "{{T .Lang "storage.dataset_deleted"}}",
        "snapshotCreated": "{{T .Lang "storage.snapshot_created"}}",
        "deleteSnapshot": "{{T .Lang "storage.delete_snapshot"}}",
        "deleteSnapshotWarning": "{{T .Lang "storage.delete_snapshot_warning"}}",
        "snapshotDeleted": "{{T .Lang "storage.snapshot_deleted"}}",
        "rollbackSnapshot": "{{T .Lang "storage.rollback_snapshot"}}",
        "rollbackWarning": "{{T .Lang "storage.rollback_warning"}}",
        "rollbackSuccess": "{{T .Lang "storage.rollback_success"}}",
        "rollbackBtn": "{{T .Lang "storage.rollback"}}",
        "formatDisk": "{{T .Lang "storage.format_disk"}}",
        "formatDiskWarning": "{{T .Lang "storage.format_disk_warning"}}",
        "diskFormatted": "{{T .Lang "storage.disk_formatted"}}",
        "mountPathError": "{{T .Lang "storage.mount_path_error"}}",
        "diskMounted": "{{T .Lang "storage.disk_mounted"}}",
        "unmountConfirm": "{{T .Lang "storage.unmount_confirm"}}",
        "diskUnmounted": "{{T .Lang "storage.disk_unmounted"}}",
        "ejectConfirm": "{{T .Lang "storage.eject_confirm"}}",
        "diskEjected": "{{T .Lang "storage.disk_ejected"}}",
        "selectAtLeastOneDisk": "{{T .Lang "storage.select_at_least_one_disk"}}",
        "noAvailableDisks": "{{T .Lang "storage.no_available_disks"}}",
        "datasetHeader": "{{T .Lang "storage.dataset"}}",
        "typeHeader": "{{T .Lang "storage.type"}}",
        "usedHeader": "{{T .Lang "storage.used"}}",
        "availableHeader": "{{T .Lang "storage.available"}}",
        "compressionHeader": "{{T .Lang "storage.compression"}}",
        "actionsHeader": "{{T .Lang "users.actions"}}",
        "snapshotHeader": "{{T .Lang "storage.snapshot"}}",
        "createdHeader": "{{T .Lang "storage.created"}}",
        "confirmAction": "{{T .Lang "storage.confirm_action"}}",
        "passwordLabel": "{{T .Lang "settings.password.current"}}",
        "smartGeneralInfo": "{{T .Lang "storage.smart.general_info"}}",
        "smartDiskErrors": "{{T .Lang "storage.smart.disk_errors"}}",
        "smartNvmeInfo": "{{T .Lang "storage.smart.nvme_info"}}",
        "smartSsdWear": "{{T .Lang "storage.smart.ssd_wear"}}",
        "smartDataVolume": "{{T .Lang "storage.smart.data_volume"}}",
        "smartAllAttributes": "{{T .Lang "storage.smart.all_attributes"}}",
        "smartHealth": "{{T .Lang "storage.health"}}",
        "smartTemp": "{{T .Lang "storage.temp"}}",
        "smartPowerOn": "{{T .Lang "storage.power_on"}}",
        "smartPowerCycles": "{{T .Lang "storage.power_cycles"}}",
        "smartReallocated": "{{T .Lang "storage.reallocated"}}",
        "smartPending": "{{T .Lang "storage.pending"}}",
        "smartUncorrectable": "{{T .Lang "storage.uncorrectable"}}",
        "smartMediaErrors": "{{T .Lang "storage.smart.media_errors"}}",
        "smartUnsafeShutdowns": "{{T .Lang "storage.smart.unsafe_shutdowns"}}",
        "smartAvailableSpare": "{{T .Lang "storage.smart.available_spare"}}",
        "smartPercentageUsed": "{{T .Lang "storage.smart.percentage_used"}}",
        "smartDataWritten": "{{T .Lang "storage.smart.data_written"}}",
        "smartDataRead": "{{T .Lang "storage.smart.data_read"}}",
        "smartStatusGood": "{{T .Lang "storage.smart.status.good"}}",
        "smartStatusWarning": "{{T .Lang "storage.smart.status.warning"}}",
        "smartStatusCritical": "{{T .Lang "storage.smart.status.critical"}}",
        "smartNotAvailable": "{{T .Lang "storage.smart_not_available"}}",
        "smartHelpHealth": "{{T .Lang "storage.smart.help.health"}}",
        "smartHelpTemp": "{{T .Lang "storage.smart.help.temperature"}}",
        "smartHelpPowerOn": "{{T .Lang "storage.smart.help.power_on_hours"}}",
        "smartHelpPowerCycles": "{{T .Lang "storage.smart.help.power_cycles"}}",
        "smartHelpReallocated": "{{T .Lang "storage.smart.help.reallocated"}}",
        "smartHelpPending": "{{T .Lang "storage.smart.help.pending"}}",
        "smartHelpUncorrectable": "{{T .Lang "storage.smart.help.uncorrectable"}}",
        "smartHelpMediaErrors": "{{T .Lang "storage.smart.help.media_errors"}}",
        "smartHelpUnsafeShutdowns": "{{T .Lang "storage.smart.help.unsafe_shutdowns"}}",
        "smartHelpAvailableSpare": "{{T .Lang "storage.smart.help.available_spare"}}",
        "smartHelpPercentageUsed": "{{T .Lang "storage.smart.help.percentage_used"}}",
        "smartHelpDataWritten": "{{T .Lang "storage.smart.help.data_written"}}",
        "smartHelpDataRead": "{{T .Lang "storage.smart.help.data_read"}}",
        "smartAttrName": "{{T .Lang "storage.attr_name"}}",
        "smartAttrValue": "{{T .Lang "storage.attr_value"}}",
        "smartAttrWorst": "{{T .Lang "storage.attr_worst"}}",
        "smartAttrRaw": "{{T .Lang "storage.attr_raw"}}"
    }
}
</script>
<script src="/static/js/storage.js"></script>
{{end}}
