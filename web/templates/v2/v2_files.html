{{define "headerActions"}}
{{if .CurrentShare}}
<button onclick="document.getElementById('uploadModal').classList.remove('hidden')" class="v2-btn v2-btn-primary" style="font-size:0.8125rem;padding:0.375rem 0.75rem;">
    <svg style="width:16px;height:16px;margin-right:0.25rem;vertical-align:middle;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
    </svg>
    {{T .Lang "files.upload"}}
</button>
<button onclick="document.getElementById('mkdirModal').classList.remove('hidden')" class="v2-btn" style="font-size:0.8125rem;padding:0.375rem 0.75rem;">
    <svg style="width:16px;height:16px;margin-right:0.25rem;vertical-align:middle;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
    </svg>
    {{T .Lang "files.new_folder"}}
</button>
{{end}}
{{end}}

{{define "content"}}
<!-- Share selector (if multiple shares) -->
{{if and (not .CurrentShare) (gt (len .Shares) 1)}}
<div class="v2-card" style="padding:2rem;text-align:center;">
    <svg style="margin:0 auto 1rem;width:48px;height:48px;color:var(--text-muted);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
    </svg>
    <h3 style="font-size:0.9375rem;font-weight:600;color:var(--text-primary);margin-bottom:0.75rem;">{{T .Lang "files.select_share"}}</h3>
    <div style="display:flex;flex-wrap:wrap;gap:0.75rem;justify-content:center;">
        {{range .Shares}}
        <a href="/files?share={{.Name}}" class="v2-btn v2-btn-primary" style="font-size:0.875rem;padding:0.5rem 1.25rem;">
            <svg style="width:18px;height:18px;margin-right:0.375rem;vertical-align:middle;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
            </svg>
            {{.Name}}
        </a>
        {{end}}
    </div>
</div>
{{else if .CurrentShare}}

<!-- Share switcher + Breadcrumb -->
<div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:1rem;flex-wrap:wrap;">
    {{if gt (len .Shares) 1}}
    <select id="shareSelector" onchange="switchShare(this.value)" style="padding:0.375rem 0.5rem;border-radius:6px;border:1px solid var(--border);background:var(--bg-card);color:var(--text-primary);font-size:0.8125rem;">
        {{range $.Shares}}
        <option value="{{.Name}}" {{if eq .Name $.CurrentShare}}selected{{end}}>{{.Name}}</option>
        {{end}}
    </select>
    {{end}}

    <nav style="display:flex;align-items:center;gap:0.25rem;font-size:0.8125rem;">
        <a href="/files?share={{.CurrentShare}}" style="color:var(--info);text-decoration:none;">
            <svg style="width:16px;height:16px;vertical-align:middle;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-4 0h4"/>
            </svg>
        </a>
        {{range .Breadcrumb}}
        <span style="color:var(--text-muted);">/</span>
        <a href="/files?share={{$.CurrentShare}}&path={{.Path}}" style="color:var(--info);text-decoration:none;">{{.Name}}</a>
        {{end}}
    </nav>
</div>

<!-- File table -->
{{if .Files}}
<div class="v2-card" style="padding:0;overflow:hidden;">
    <table class="v2-table">
        <thead>
            <tr>
                <th>{{T .Lang "files.column.name"}}</th>
                <th>{{T .Lang "files.column.size"}}</th>
                <th>{{T .Lang "files.column.modified"}}</th>
                <th style="text-align:right;">{{T .Lang "files.column.actions"}}</th>
            </tr>
        </thead>
        <tbody>
            {{range .Files}}
            <tr>
                <td>
                    <div style="display:flex;align-items:center;gap:0.5rem;">
                        {{if .IsDir}}
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--warning)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                        </svg>
                        <a href="/files?share={{$.CurrentShare}}&path={{.Path}}" style="font-weight:500;color:var(--info);text-decoration:none;">{{.Name}}</a>
                        {{else}}
                        {{if eq .MimeType "image"}}
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/>
                        </svg>
                        {{else if eq .MimeType "video"}}
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--error)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                        </svg>
                        {{else if eq .MimeType "audio"}}
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--info)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>
                        </svg>
                        {{else if eq .MimeType "document"}}
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--info)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/>
                        </svg>
                        {{else if eq .MimeType "archive"}}
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--warning)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 8v13H3V8"/><path d="M1 3h22v5H1z"/><path d="M10 12h4"/>
                        </svg>
                        {{else}}
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/>
                        </svg>
                        {{end}}
                        <span style="font-weight:500;color:var(--text-primary);">{{.Name}}</span>
                        {{end}}
                    </div>
                </td>
                <td style="color:var(--text-secondary);white-space:nowrap;">
                    {{if .IsDir}}
                        &mdash;
                    {{else}}
                        {{FormatBytes .Size}}
                    {{end}}
                </td>
                <td style="color:var(--text-muted);white-space:nowrap;">
                    {{FormatTime .ModTime $.Lang}}
                </td>
                <td style="text-align:right;">
                    <div style="display:flex;align-items:center;justify-content:flex-end;gap:0.375rem;">
                        {{if not .IsDir}}
                        {{if and $.OOEnabled (IsOOEditable .Name)}}
                        <a href="/files/edit?share={{$.CurrentShare}}&path={{.Path}}" class="v2-btn" style="font-size:0.75rem;padding:0.25rem 0.5rem;background:rgba(16,185,129,0.12);color:var(--success);border:1px solid rgba(16,185,129,0.2);text-decoration:none;">
                            {{T $.Lang "files.action.edit"}}
                        </a>
                        {{end}}
                        <a href="/api/files/download?share={{$.CurrentShare}}&path={{.Path}}" class="v2-btn" style="font-size:0.75rem;padding:0.25rem 0.5rem;background:rgba(99,102,241,0.12);color:var(--info);border:1px solid rgba(99,102,241,0.2);text-decoration:none;">
                            {{T $.Lang "files.action.download"}}
                        </a>
                        {{end}}
                        <button onclick="renameItem('{{$.CurrentShare}}', '{{.Path}}', '{{.Name}}')" class="v2-btn" style="font-size:0.75rem;padding:0.25rem 0.5rem;background:rgba(245,158,11,0.12);color:var(--warning);border:1px solid rgba(245,158,11,0.2);">
                            {{T $.Lang "files.action.rename"}}
                        </button>
                        <button onclick="deleteItem('{{$.CurrentShare}}', '{{.Path}}', '{{.Name}}')" class="v2-btn" style="font-size:0.75rem;padding:0.25rem 0.5rem;background:rgba(239,68,68,0.12);color:var(--error);border:1px solid rgba(239,68,68,0.2);">
                            {{T $.Lang "files.action.delete"}}
                        </button>
                    </div>
                </td>
            </tr>
            {{end}}
        </tbody>
    </table>
</div>
{{else}}
<!-- Empty folder -->
<div class="v2-card" style="padding:3rem;text-align:center;">
    <svg style="margin:0 auto 1rem;width:48px;height:48px;color:var(--text-muted);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
    </svg>
    <h3 style="font-size:0.9375rem;font-weight:600;color:var(--text-primary);margin-bottom:0.25rem;">{{T .Lang "files.empty"}}</h3>
    <p style="font-size:0.8125rem;color:var(--text-muted);">{{T .Lang "files.empty_hint"}}</p>
</div>
{{end}}
{{end}}

<!-- Upload modal -->
<div id="uploadModal" class="hidden" style="position:fixed;inset:0;z-index:1000;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);">
    <div class="v2-card" style="width:90%;max-width:480px;padding:1.5rem;">
        <h3 style="font-size:1rem;font-weight:600;color:var(--text-primary);margin-bottom:1rem;">{{T .Lang "files.upload_title"}}</h3>
        <form id="uploadForm" enctype="multipart/form-data">
            <input type="file" id="uploadFiles" name="files" multiple style="width:100%;margin-bottom:1rem;padding:0.5rem;border:1px dashed var(--border);border-radius:6px;background:var(--bg-page);color:var(--text-primary);">
            <div id="uploadProgress" class="hidden" style="margin-bottom:1rem;">
                <div style="height:6px;border-radius:3px;background:var(--border);overflow:hidden;">
                    <div id="uploadBar" style="height:100%;width:0%;background:var(--info);transition:width 0.3s;"></div>
                </div>
                <span id="uploadPercent" style="font-size:0.75rem;color:var(--text-muted);">0%</span>
            </div>
            <div style="display:flex;gap:0.5rem;justify-content:flex-end;">
                <button type="button" onclick="document.getElementById('uploadModal').classList.add('hidden')" class="v2-btn" style="font-size:0.8125rem;padding:0.375rem 0.75rem;">{{T .Lang "files.cancel"}}</button>
                <button type="submit" class="v2-btn v2-btn-primary" style="font-size:0.8125rem;padding:0.375rem 0.75rem;">{{T .Lang "files.upload"}}</button>
            </div>
        </form>
    </div>
</div>

<!-- Mkdir modal -->
<div id="mkdirModal" class="hidden" style="position:fixed;inset:0;z-index:1000;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);">
    <div class="v2-card" style="width:90%;max-width:400px;padding:1.5rem;">
        <h3 style="font-size:1rem;font-weight:600;color:var(--text-primary);margin-bottom:1rem;">{{T .Lang "files.new_folder_title"}}</h3>
        <form id="mkdirForm">
            <input type="text" id="mkdirName" placeholder="{{T .Lang "files.folder_name_placeholder"}}" style="width:100%;margin-bottom:1rem;padding:0.5rem;border:1px solid var(--border);border-radius:6px;background:var(--bg-page);color:var(--text-primary);box-sizing:border-box;">
            <div style="display:flex;gap:0.5rem;justify-content:flex-end;">
                <button type="button" onclick="document.getElementById('mkdirModal').classList.add('hidden')" class="v2-btn" style="font-size:0.8125rem;padding:0.375rem 0.75rem;">{{T .Lang "files.cancel"}}</button>
                <button type="submit" class="v2-btn v2-btn-primary" style="font-size:0.8125rem;padding:0.375rem 0.75rem;">{{T .Lang "files.create"}}</button>
            </div>
        </form>
    </div>
</div>

<!-- Rename modal -->
<div id="renameModal" class="hidden" style="position:fixed;inset:0;z-index:1000;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);">
    <div class="v2-card" style="width:90%;max-width:400px;padding:1.5rem;">
        <h3 style="font-size:1rem;font-weight:600;color:var(--text-primary);margin-bottom:1rem;">{{T .Lang "files.rename_title"}}</h3>
        <form id="renameForm">
            <input type="hidden" id="renameOldPath" value="">
            <input type="hidden" id="renameShare" value="">
            <input type="text" id="renameNewName" style="width:100%;margin-bottom:1rem;padding:0.5rem;border:1px solid var(--border);border-radius:6px;background:var(--bg-page);color:var(--text-primary);box-sizing:border-box;">
            <div style="display:flex;gap:0.5rem;justify-content:flex-end;">
                <button type="button" onclick="document.getElementById('renameModal').classList.add('hidden')" class="v2-btn" style="font-size:0.8125rem;padding:0.375rem 0.75rem;">{{T .Lang "files.cancel"}}</button>
                <button type="submit" class="v2-btn v2-btn-primary" style="font-size:0.8125rem;padding:0.375rem 0.75rem;">{{T .Lang "files.rename_confirm"}}</button>
            </div>
        </form>
    </div>
</div>

<script>
const currentShare = '{{.CurrentShare}}';
const currentPath = '{{.CurrentPath}}';

const fileI18n = {
    confirm_delete: '{{T .Lang "files.confirm_delete"}}',
    delete_success: '{{T .Lang "files.delete_success"}}',
    mkdir_success: '{{T .Lang "files.mkdir_success"}}',
    rename_success: '{{T .Lang "files.rename_success"}}',
    upload_success: '{{T .Lang "files.upload_success"}}',
    error: '{{T .Lang "files.error_generic"}}'
};

function switchShare(name) {
    window.location.href = '/files?share=' + encodeURIComponent(name);
}

function renameItem(share, path, oldName) {
    document.getElementById('renameShare').value = share;
    document.getElementById('renameOldPath').value = path;
    document.getElementById('renameNewName').value = oldName;
    document.getElementById('renameModal').classList.remove('hidden');
    document.getElementById('renameNewName').focus();
    document.getElementById('renameNewName').select();
}

function deleteItem(share, path, name) {
    if (!confirm(fileI18n.confirm_delete + '\n\n' + name)) return;
    fetch('/api/files/delete', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({share: share, path: path})
    }).then(r => r.json()).then(data => {
        if (data.success) { window.location.reload(); }
        else { alert(fileI18n.error + ' ' + (data.message || '')); }
    }).catch(err => alert(fileI18n.error + ' ' + err));
}

document.getElementById('mkdirForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const name = document.getElementById('mkdirName').value.trim();
    if (!name) return;
    fetch('/api/files/mkdir', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({share: currentShare, path: currentPath, name: name})
    }).then(r => r.json()).then(data => {
        if (data.success) {
            document.getElementById('mkdirModal').classList.add('hidden');
            window.location.reload();
        } else { alert(fileI18n.error + ' ' + (data.message || '')); }
    }).catch(err => alert(fileI18n.error + ' ' + err));
});

document.getElementById('renameForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const newName = document.getElementById('renameNewName').value.trim();
    if (!newName) return;
    const share = document.getElementById('renameShare').value;
    const oldPath = document.getElementById('renameOldPath').value;
    fetch('/api/files/rename', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({share: share, path: oldPath, new_name: newName})
    }).then(r => r.json()).then(data => {
        if (data.success) {
            document.getElementById('renameModal').classList.add('hidden');
            window.location.reload();
        } else { alert(fileI18n.error + ' ' + (data.message || '')); }
    }).catch(err => alert(fileI18n.error + ' ' + err));
});

document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const files = document.getElementById('uploadFiles').files;
    if (files.length === 0) return;
    const formData = new FormData();
    formData.append('share', currentShare);
    formData.append('path', currentPath);
    for (let i = 0; i < files.length; i++) {
        formData.append('files', files[i]);
    }
    const xhr = new XMLHttpRequest();
    const progressDiv = document.getElementById('uploadProgress');
    const bar = document.getElementById('uploadBar');
    const pct = document.getElementById('uploadPercent');
    progressDiv.classList.remove('hidden');
    xhr.upload.addEventListener('progress', function(ev) {
        if (ev.lengthComputable) {
            const percent = Math.round((ev.loaded / ev.total) * 100);
            bar.style.width = percent + '%';
            pct.textContent = percent + '%';
        }
    });
    xhr.addEventListener('load', function() {
        if (xhr.status === 200) {
            document.getElementById('uploadModal').classList.add('hidden');
            window.location.reload();
        } else {
            try {
                const data = JSON.parse(xhr.responseText);
                alert(fileI18n.error + ' ' + (data.message || ''));
            } catch(e) { alert(fileI18n.error); }
        }
        progressDiv.classList.add('hidden');
        bar.style.width = '0%';
    });
    xhr.addEventListener('error', function() {
        alert(fileI18n.error);
        progressDiv.classList.add('hidden');
    });
    xhr.open('POST', '/api/files/upload');
    xhr.send(formData);
});

// Close modals on background click
['uploadModal', 'mkdirModal', 'renameModal'].forEach(function(id) {
    document.getElementById(id).addEventListener('click', function(e) {
        if (e.target === this) this.classList.add('hidden');
    });
});
</script>
{{end}}
